/**
 * @project jQuery.sheet() The Ajax Spreadsheet - http://code.google.com/p/jquerysheet/
 * @author RobertLeePlummerJr@gmail.com
 * $Id: jquery.sheet.min.js 771 2013-03-25 17:17:21Z RobertLeePlummerJr $
 * Licensed under MIT
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 */
jQuery.fn.extend({sheet:function(a){a=a||{};jQuery(this).each(function(){var j=Globalize,f=jQuery(this),h={editable:true,editableNames:true,barMenus:true,freezableCells:true,allowToggleState:true,menuLeft:null,newColumnWidth:120,title:null,menuRight:null,calcOff:false,log:false,lockFormulas:false,parent:f,colMargin:18,boxModelCorrection:2,formulaFunctions:{},formulaVariables:{},cellSelectModel:"excel",autoAddCells:true,resizableCells:true,resizableSheet:true,autoFiller:true,minSize:{rows:1,cols:1},alertFormulaErrors:false,error:function(k){return k.error},endOfNumber:false,encode:function(m){if(!this.endOfNumber){var l=j.culture().numberFormat["."];this.endOfNumber=new RegExp("(["+(l=="."?".":l)+"])([0-9]*?[1-9]+)?(0)*$")}switch(typeof m){case"object":return m;case"number":return j.format(m,"n10").replace(this.endOfNumber,function(p,o,n){return(n?o:"")+(n||"")})}if(!m){return m||""}if(!m.replace){return m||""}var k=$.trim(m)*1;if(!isNaN(k)){return j.format(k,"n10").replace(this.endOfNumber,function(p,o,n){return(n?o:"")+(n||"")})}return m.replace(/&/gi,"&amp;").replace(/>/gi,"&gt;").replace(/</gi,"&lt;").replace(/\n/g,"\n<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp ").replace(/  /g,"&nbsp; ")},frozenAt:[],contextmenuTop:{"Toggle freeze columns to here":function(l){var k=l.getTdLocation(l.obj.tdActive()).col;l.frozenAt().col=(l.frozenAt().col==k?0:k)},"Insert column after":function(k){k.controlFactory.addColumn(k.colLast);return false},"Insert column before":function(k){k.controlFactory.addColumn(k.colLast,true);return false},"Add column to end":function(k){k.controlFactory.addColumn();return false},"Delete this column":function(k){k.deleteColumn();return false},"Hide column":function(k){k.toggleHide.column();return false}},contextmenuLeft:{"Toggle freeze rows to here":function(k){var l=k.getTdLocation(k.obj.tdActive()).row;k.frozenAt().row=(k.frozenAt().row==l?0:l)},"Insert row after":function(k){k.controlFactory.addRow(k.rowLast);return false},"Insert row before":function(k){k.controlFactory.addRow(k.rowLast,true);return false},"Add row to end":function(k){k.controlFactory.addRow();return false},"Delete this row":function(k){k.deleteRow();return false},"Hide row":function(k){k.toggleHide.row();return false}},contextmenuCell:{Copy:false,Cut:false,"Insert column after":function(k){k.controlFactory.addColumn(k.colLast);return false},"Insert column before":function(k){k.controlFactory.addColumn(k.colLast,true);return false},"Add column to end":function(k){k.controlFactory.addColumn();return false},"Delete this column":function(k){k.deleteColumn();return false},line1:"line","Insert row after":function(k){k.controlFactory.addRow(k.rowLast);return false},"Insert row before":function(k){k.controlFactory.addRow(k.rowLast,true);return false},"Add row to end":function(k){k.controlFactory.addRow();return false},"Delete this row":function(k){k.deleteRow();return false},line2:"line","Add spreadsheet":function(k){k.addSheet({rows:25,cols:10})},"Delete spreadsheet":function(k){k.deleteSheet()}},hiddenRows:[],hiddenColumns:[],cellStartingHandlers:{"$":function(l,k){this.formula="";this.value=l;this.valueOverride=jFN.DOLLAR.apply(this,[l.substring(1).replace(j.culture().numberFormat[","],""),2,k||"$"]).value;this.td.removeData("formula").html(l)},"£":function(k){g.s.cellStartingHandlers["$"].apply(this,[k,"£"])}},cellEndHandlers:{"%":function(k){this.value=k;this.valueOverride=k.substring(0,this.value.length-1)/100}}},d=jQuery.sheet.events;var g=f.getSheet();if(g){var c=f.children().detach();g.kill();f.html(c);for(var b in d){if(a[d[b]]){f.unbind(d[b])}}}for(var b in d){if(a[d[b]]){f.bind(d[b],a[d[b]])}}if(!jQuery.sheet.instance.length){jQuery.sheet.instance=$([])}g=jQuery.sheet.createInstance(jQuery,jQuery.extend(h,a),jQuery.sheet.instance.length);jQuery.sheet.instance=jQuery.sheet.instance.add(g)});return this},disableSelectionSpecial:function(){this.each(function(){this.onselectstart=function(){return false};this.unselectable="on";jQuery(this).css("-moz-user-select","none")});return this},getSheet:function(){return jQuery(this).data("sheetInstance")},getCellValue:function(f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{return c.updateCellValue(b,f,a)}catch(d){return""}},setCellValue:function(d,g,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][g][a].value=d;return c.updateCellValue(b,g,a)}catch(f){}},setCellFormula:function(g,f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][f][a].formula=g;return c.updateCellValue(b,f,a)}catch(d){}},setCellHtml:function(c,g,a,b){var d=jQuery(this).getSheet();b=(b?b:0);try{d.spreadsheets[b][g][a].html=[c];return d.updateCellValue(b,g,a)}catch(f){}},isSheetFullScreen:function(){var a=$(this).getSheet();if(a.obj.fullScreen().is(":visible")){return true}else{return false}},serializeCellInputs:function(c){var b=$(this).getSheet(),a=b.obj.tables().find(":input");if(c){return a.serializeArray()}else{return a.serialize()}},viewSource:function(b){var a="";if(b){jQuery(this).each(function(){a+=jQuery(this).toPrettySource()})}else{jQuery(this).each(function(){a+=jQuery(this).toCompactSource()})}$.print(a);return false},toCompactSource:function(){var g=this[0];var b="";if(g.nodeType==1){b+="<"+g.tagName.toLowerCase();d=false;var j=g.attributes.length;for(var f=0,d=false;f<j;f++){var c=g.attributes[f].name,h=g.getAttribute(c);if(h){if(c=="contentEditable"&&h=="inherit"){continue}if(c=="class"){d=true}if(typeof(h)=="string"){b+=" "+c+'="'+h.replace(/"/g,"'")+'"'}else{if(c=="style"&&h.cssText){b+=' style="'+h.cssText+'"'}}}}if(g.tagName=="COL"){b+="/>"}else{b+=">";var a="";jQuery(g.childNodes).each(function(){a+=jQuery(this).toCompactSource()});b+=a;b+="</"+g.tagName.toLowerCase()+">"}}else{if(g.nodeType==3){b+=g.data.replace(/^\s*(.*)\s*$/g,"$1")}}return b},toPrettySource:function(g){var f=this[0];g=g||"";var b="";if(f.nodeType==1){b+="\n"+g+"<"+f.tagName.toLowerCase();var j=f.attributes.length;for(var d=0;d<j;d++){var c=f.attributes[d].name,h=f.getAttribute(c);if(h){if(c=="contentEditable"&&h=="inherit"){continue}if(typeof(h)=="string"){b+=" "+c+'="'+$.trim(h.replace(/"/g,"'"))+'"'}else{if(c=="style"&&h.cssText){b+=' style="'+$.trim(h.cssText)+'"'}}}}if(f.childNodes.length<=0){if(f.tagName=="COL"){b+="/>"}else{b+="></"+f.tagName.toLowerCase()+">"}}else{b+=">";var a="",j=f.childNodes.length;for(var d=0;d<j;d++){a+=$(f.childNodes[d]).toPrettySource(g+"  ")}b+=a;if(a.indexOf("\n")>=0){b+="\n"+g}b+="</"+f.tagName.toLowerCase()+">"}}else{if(f.nodeType==3){b+=f.data.replace(/^\s*(.*)\s*$/g,"$1")}}return b}});jQuery.sheet={instance:[],dependencies:{coreCss:{css:"jquery.sheet.css"},jQueryUI:{script:"jquery-ui/ui/jquery-ui.min.js"},jQueryUIThemeroller:{css:"jquery-ui/theme/jquery-ui.min.css"},globalize:{script:"plugins/globalize.js"},formulaParser:{script:"parser/formula/formula.js"},tsvParser:{script:"parser/tsv/tsv.js"},mousewheel:{script:"plugins/jquery.mousewheel.min.js"},nearest:{script:"plugins/jquery.nearest.min.js"}},optional:{globalizeCultures:{script:"plugins/globalize.cultures.js"},raphael:{script:"plugins/raphael-min.js"},gRaphael:{script:"plugins/g.raphael-min.js"},colorPicker:{css:"plugins/jquery.colorPicker.css"},colorPicker:{script:"plugins/jquery.colorPicker.min.js"},elastic:{script:"plugins/jquery.elastic.min.js"},advancedfn:{script:"plugins/jquery.sheet.advancedfn.js"},financefn:{script:"plugins/jquery.sheet.financefn.js"},dts:{script:"plugins/jquery.sheet.dts.js"},zeroclipboard:{script:"plugins/ZeroClipboard.js"}},events:["sheetAddRow","sheetAddColumn","sheetSwitch","sheetRename","sheetTabSortStart","sheetTabSortUpdate","sheetCellEdit","sheetCellEdited","sheetCalculation","sheetAdd","sheetDelete","sheetDeleteRow","sheetDeleteColumn","sheetOpen","sheetAllOpened","sheetSave","sheetFullScreen","sheetFormulaKeydown"],preLoad:function(d,b){d=d||"";b=$.extend({skip:["globalizeCultures"]},b);var c=function(){if(this.script){document.write('<script src="'+d+this.script+'"><\/script>')}else{if(this.css){document.write('<link rel="stylesheet" type="text/css" href="'+d+this.css+'"></link>')}}};for(var a in b.skip){if(this.dependencies[b.skip[a]]){this.dependencies[b.skip[a]]=null}if(this.optional[b.skip[a]]){this.optional[b.skip[a]]=null}}$.each(this.dependencies,function(){c.apply(this)});$.each(this.optional,function(){c.apply(this)})},repeat:function(c,b){var a="";while(b>0){if(b&1){a+=c}b>>=1,c+=c}return a},nthCss:function(a,j,h,c,f,d){var g=[],b=c.length;d=d||"{display: none;}";if(h.styleSheet){do{if(c[b]>f){g.push(j+" "+a+":first-child"+this.repeat("+"+a,c[b]-1))}}while(b--);if(g.length){return g.join(",")+d}}else{do{if(c[b]>f){g.push(j+" "+a+":nth-child("+c[b]+")")}}while(b--);if(g.length){return g.join(",")+d}}return""},createInstance:function(d,p,l){var o=this,g=function(s,q){var r=q.parentNode;if(r.lastchild==q){r.appendChild(s)}else{r.insertBefore(s,q.nextSibling)}},f={version:"3.x",i:0,I:l,sheetCount:0,scrolledArea:[],spreadsheets:[],controls:{autoFiller:[],bar:{helper:[],corner:[],x:{controls:[],handleFreeze:[],menu:[],menuParent:[],parent:[],scroll:[],td:[],tds:function(){var r=d([]);for(var q in this.td[f.i]){r=r.add(this.td[f.i][q])}return r}},y:{controls:[],handleFreeze:[],menu:[],parent:[],scroll:[],td:[],tds:function(){var r=d([]);for(var q in this.td[f.i]){r=r.add(this.td[f.i][q])}return r}}},barMenuLeft:[],barMenuTop:[],barLeft:[],barTop:[],barTopParent:[],chart:[],tdMenu:[],cellsEdited:[],enclosure:[],enclosures:null,formula:null,fullScreen:[],header:null,inPlaceEdit:[],inputs:[],label:null,menuLeft:[],menuRight:[],pane:[],panes:null,scroll:[],scrolls:null,table:[],tabls:null,tab:[],tabContainer:null,tabs:null,title:null,toggleHide:{x:[],y:[]},ui:null},obj:{autoFiller:function(){return f.controls.autoFiller[f.i]||d([])},barCorner:function(){return f.controls.bar.corner[f.i]||d([])},barHelper:function(){return f.controls.bar.helper[f.i]||(f.controls.bar.helper[f.i]=d([]))},barLeft:function(q){return(f.controls.bar.y.td[f.i]&&f.controls.bar.y.td[f.i][q]?f.controls.bar.y.td[f.i][q]:d([]))},barLeftControls:function(){return f.controls.bar.y.controls[f.i]||d([])},barLefts:function(){return f.controls.bar.y.tds()},barHandleFreezeLeft:function(){return f.controls.bar.y.handleFreeze[f.i]||d([])},barMenuLeft:function(){return f.controls.bar.y.menu[f.i]||d([])},barTop:function(q){return(f.controls.bar.x.td[f.i]&&f.controls.bar.x.td[f.i][q]?f.controls.bar.x.td[f.i][q]:d([]))},barTopControls:function(){return f.controls.bar.x.controls[f.i]||d([])},barTops:function(){return f.controls.bar.x.tds()},barTopParent:function(){return f.controls.bar.x.parent[f.i]||d([])},barHandleFreezeTop:function(){return f.controls.bar.x.handleFreeze[f.i]||d([])},barMenuParentTop:function(){return f.controls.bar.x.menuParent[f.i]||d([])},barMenuTop:function(){return f.controls.bar.x.menu[f.i]||d([])},tdActive:function(){return f.cellLast.td||d([])},tdMenu:function(){return f.controls.tdMenu[f.i]||d([])},cellsEdited:function(){return f.controls.cellsEdited[f.i]||d([])},chart:function(){return f.controls.chart[f.i]||d([])},enclosure:function(){return f.controls.enclosure[f.i]||d([])},enclosures:function(){return f.controls.enclosures||d([])},formula:function(){return f.controls.formula||d([])},fullScreen:function(){return f.controls.fullScreen[f.i]||d([])},header:function(){return f.controls.header||d([])},highlighted:function(){return f.highlightedLast.obj||d([])},menuRight:function(){return f.controls.menuRight[f.i]||d([])},inPlaceEdit:function(){return f.controls.inPlaceEdit[f.i]||d([])},inputs:function(){return f.controls.inputs[f.i]||d([])},label:function(){return f.controls.label||d([])},menuLeft:function(){return f.controls.menuLeft[f.i]||d([])},pane:function(){return f.controls.pane[f.i]||{}},panes:function(){return f.controls.panes||d([])},parent:function(){return p.parent},scrollStyleX:function(){return f.controls.bar.x.scroll[f.i]||{}},scrollStyleY:function(){return f.controls.bar.y.scroll[f.i]||d([])},scroll:function(){return f.controls.scroll[f.i]||d([])},scrolls:function(){return f.controls.scrolls||d([])},table:function(){return f.controls.table[f.i]||d([])},tables:function(){return f.controls.tables||d([])},tab:function(){return f.controls.tab[f.i]||d([])},tabs:function(){return f.controls.tabs||d([])},tabContainer:function(){return f.controls.tabContainer||d([])},toggleHideStyleX:function(){return f.controls.toggleHide.x[f.i]||d([])},toggleHideStyleY:function(){return f.controls.toggleHide.y[f.i]||d([])},title:function(){return f.controls.title||d([])},ui:function(){return f.controls.ui||d([])}},id:{table:"jS_"+l+"_"},cl:{autoFiller:"jSAutoFiller",autoFillerHandle:"jSAutoFillerHandle",autoFillerCover:"jSAutoFillerCover",barCorner:"jSBarCorner",barController:"jSBarController",barHelper:"jSBarHelper",barLeft:"jSBarLeft",barHandleFreezeLeft:"jSBarHandleFreezeLeft",barTop:"jSBarTop",barHandleFreezeTop:"jSBarHandleFreezeTop",barTopParent:"jSBarTopParent",chart:"jSChart",formula:"jSFormula",formulaParent:"jSFormulaParent",header:"jSHeader",fullScreen:"jSFullScreen",inPlaceEdit:"jSInPlaceEdit",menu:"jSMenu",menuFixed:"jSMenuFixed",parent:"jSParent",scroll:"jSScroll",table:"jS",label:"jSLoc",pane:"jSEditPane",tab:"jSTab",tabContainer:"jSTabContainer",title:"jSTitle",enclosure:"jSEnclosure",ui:"jSUI",uiAutoFiller:"ui-state-active",uiBar:"ui-widget-header",uiBarHighlight:"ui-state-active",uiBarHandleFreezeLeft:"ui-state-default",uiBarHandleFreezeTop:"ui-state-default",uiBarMenuTop:"ui-state-default",uiTdActive:"ui-state-active",uiTdHighlighted:"ui-state-highlight",uiControl:"ui-widget-header ui-corner-top",uiControlTextBox:"ui-widget-content",uiFullScreen:"ui-widget-content ui-corner-all",uiInPlaceEdit:"ui-state-highlight",uiMenu:"ui-widget-header",uiMenuUl:"ui-widget-header",uiMenuLi:"ui-widget-header",uiPane:"ui-widget-content",uiParent:"ui-widget-content ui-corner-all",uiTable:"ui-widget-content",uiTab:"ui-widget-header",uiTabActive:"ui-state-highlight"},msg:{addRowMulti:"How many rows would you like to add?",addColumnMulti:"How many columns would you like to add?",cellFind:"What are you looking for in this spreadsheet?",cellNoFind:"No results found.",dragToFreezeCol:"Drag to freeze column",dragToFreezeRow:"Drag to freeze row",addSheet:"Add a spreadsheet",newSheet:"What size would you like to make your spreadsheet? Example: '5x10' creates a sheet that is 5 columns by 10 rows.",openSheet:"Are you sure you want to open a different sheet?  All unsaved changes will be lost.",toggleHideRow:"No row selected.",toggleHideColumn:"Now column selected.",loopDetected:"Loop Detected",newSheetTitle:"What would you like the sheet's title to be?",notFoundColumn:"Column not found",notFoundRow:"Row not found",notFoundSheet:"Sheet not found",setCellRef:"Enter the name you would like to reference the cell by.",sheetTitleDefault:"Spreadsheet {index}"},kill:function(){c.unbind("keydown");f.obj.fullScreen().remove();f.obj.inPlaceEdit().trigger("destroy");p.parent.trigger("sheetKill").removeClass(f.cl.uiParent).html("").removeData("sheetInstance");for(var q in d.sheet.events){p.parent.unbind(d.sheet.events[q])}d.sheet.instance.splice(l,1);f=null},trigger:function(q,r){r=r||[];p.parent.trigger(q,[f].concat(r))},spreadsheetsToArray:function(q){if(q||f.spreadsheets.length==0){f.cycleCellsAll(function(s,t,r){f.createCell(s,t,r)})}return f.spreadsheets},spreadsheetToArray:function(r,q){q=(q?q:f.i);if(r||!f.spreadsheets[q]){f.cycleCells(function(t,u,s){f.createCell(t,u,s)})}},createCell:function(v,y,A,D,C,G){var r,w,z,F,B,s,t,q,x,u,H,E;if(!(r=f.spreadsheets[v])){r=f.spreadsheets[v]=[]}if(!(w=r[y])){w=r[y]=[]}if(!(F=f.controls.tables[v])){return{}}if(!(t=F.tbody)){return{}}if(!(q=t.children[y])){return{}}if(!(x=q.children[A])){return{}}u=d(x);z=w[A]=x.jSCell={td:u,dependencies:{},formula:x.getAttribute("data-formula")||"",value:x.textContent||x.innerText||"",calcCount:D||0,calcLast:C||-1,calcDependenciesLast:G||-1,html:[],sheet:v,type:"cell",jS:f,state:[],needsUpdated:true};if(z.formula&&z.formula.charAt(0)=="="){z.formula=z.formula.substring(1)}B=F.colgroup;if(!(s=B.children[A]).jSCells){s.jSCells=[]}s.jSCells.unshift(z);if(!s.tds){s.tds=[]}s.tds.unshift(x);x.col=s;x.type="cell";x.barLeft=q.children[0];x.barTop=t.children[0].children[A];if(!q.jSCells){q.jSCells=[]}q.jSCells.unshift(z);if(!q.tds){q.tds=[]}q.tds.unshift(x);if(!F.jSCells){F.jSCells=[]}F.jSCells.unshift(z);if(!F.tds){F.tds=[]}F.tds.unshift(x);x.table=F;if(!(E=f.controls.bar.y.td[v])){E=f.controls.bar.y.td[v]=[]}if(!E[y]){E[y]=d(q.children[0])}if(!(H=f.controls.bar.x.td[v])){H=f.controls.bar.x.td[v]=[]}if(!H[A]){H[A]=d(t.children[0].children[A])}return z},nav:false,setNav:function(q){d.sheet.instance.each(function(){this.nav=false});f.nav=q},controlFactory:{addRowMulti:function(r,t,q,s){if(!t){t=prompt(f.msg.addRowMulti)}if(t){if(!isNaN(t)){f.controlFactory.addCells(r,q,parseInt(t),"row",s);f.trigger("sheetAddRow",[r,q,t])}}},addColumnMulti:function(r,t,q,s){if(!t){t=prompt(f.msg.addColumnMulti)}if(t){if(!isNaN(t)){f.controlFactory.addCells(r,q,parseInt(t),"col",s);f.trigger("sheetAddColumn",[r,q,t])}}},addCells:function(z,x,F,E,A){f.autoFillerHide();f.setDirty(true);f.setChanged(true);f.obj.barHelper().remove();var C=f.obj.table(),D=C[0],q=f.sheetSize(D),y=false,v=f.obj.tdActive(),s;F=F||1;E=E||"col";if(z==n){z=(E=="row"?q.rows:q.cols);y=true}switch(E){case"row":s={el:function(){var G=f.rowTds(D,z);if(!G||!G[0]){return[]}return[G[0].parentNode]},size:function(){if(!s.Size){var G=s.el()[0];s.Size=G.children.length-1}return s.Size},loc:function(){var G=s.el();return f.getTdLocation(G[0].children)},trs:[],newObj:function(){var G=s.size(),I=k.createElement("tr");I.setAttribute("style","height: "+p.colMargin+"px;");for(var H=0;H<=G;H++){var J=k.createElement("td");if(H==0){J.setAttribute("class",f.cl.barLeft+" "+f.cl.uiBar);J.entity="left";J.type="bar"}I.appendChild(J)}s.trs.push(I);return I},offset:{row:F,col:0},start:function(){return{row:(x?z:z+F)}},createCells:function(){for(var I=0;I<s.trs.length;I++){I=I*1;var H=(x?0:1)+z;f.spreadsheets[f.i].splice(I+H,0,[]);for(var G=0;G<s.trs[I].children.length;G++){G=G*1;if(G==0){f.controls.bar.y.td[f.i].splice(I+H,0,d(s.trs[I].children[G]))}else{f.createCell(f.i,I+H,G)}}}f.refreshRowLabels(z)}};break;case"col":s={el:function(){var H=f.rowTds(D,1)[z],K=f.rowTds(D),M=K[K.length-1],L=f.getTdLocation(H),J=f.getTdLocation(M),I=[];for(var G=0;G<=J.row;G++){I.push(D.tbody.children[G].children[z])}return I},col:function(){return f.col(D,z)},cols:[],newCol:function(){var G=k.createElement("col");G.setAttribute("style","width:"+f.s.newColumnWidth+"px;");s.cols.push(G);return G},loc:function(G){G=(G?G:s.el());return f.getTdLocation(G[0])},tds:[],newObj:function(){var G=k.createElement("td");s.tds.push(G);return G},offset:{row:0,col:F},start:function(){return{col:(x?z:z+F)}},createCells:function(){var I=f.rows(D);for(var K=0;K<I.length;K++){var H=(x?0:1)+z,M=H+F,G=0;for(H;H<M;H++){var L=D.tbody.children[K].children[H],J=d(L);if(K==0){f.controls.bar.x.td[f.i].splice(H,0,J);L.innerText=jSE.columnLabelString(H);L.className=f.cl.barTop+" "+f.cl.uiBar;L.type="bar";L.entity="top";s.cols[G].setAttribute("style","width:"+f.s.newColumnWidth+"px;");s.cols[G].bar=L;G++}else{f.spreadsheets[f.i][K].splice(H,0,{});f.createCell(f.i,K,H)}}}f.refreshColumnLabels(z)}};break}var r=s.el(),B=s.loc(r),t,w=r.length-1,u;if(x){do{u=F-1;do{r[w].parentNode.insertBefore(s.newObj(),r[w])}while(u--)}while(w--);if(s.newCol){t=s.col();u=F-1;do{t.parentNode.insertBefore(s.newCol(),t)}while(u--)}}else{do{u=F-1;do{g(s.newObj(),r[w])}while(u--)}while(w--);if(s.newCol){t=s.col();u=F-1;do{g(s.newCol(),t)}while(u--)}}s.createCells();if(!A&&y!=true){f.offsetFormulas(B,s.offset,x)}f.obj.pane().resizeScroll();if(v&&v[0]&&v[0].cellIndex&&v[0].parentNode){f.colLast=v[0].cellIndex;f.rowLast=v[0].parentNode.rowIndex}},addRow:function(r,q){f.controlFactory.addCells(r,q,1,"row");f.trigger("sheetAddRow",[r,q,1])},addColumn:function(r,q){f.controlFactory.addCells(r,q,1,"col");f.trigger("sheetAddColumn",[r,q,1])},barLeft:function(r){var s=r.tbody.children,q=s.length-1,t;r.barLeft=[];if(q>-1){do{t=k.createElement("td");r.barLeft.unshift(t);s[q].insertBefore(t,s[q].children[0])}while(q-->1)}},barTop:function(y){var s=y.colgroup,x=s.children,u,q=y.tbody.children[0],w=k.createElement("col"),t=k.createElement("td"),v=k.createElement("tr");w.width=p.colMargin+"px";w.style.width=w.width;s.insertBefore(w,s.children[0]);v.appendChild(t);v.className=f.cl.barTopParent;y.tbody.insertBefore(v,y.tbody.children[0]);y.barTopParent=v;f.controls.barTopParent[f.i]=d(v);u=q.children.length-1;do{var r=k.createElement("td");if(!x[u]){x[u]=k.createElement("col");s.insertBefore(x[u],w.nextSibling)}x[u].bar=r;r.col=x[u];v.insertBefore(r,t.nextSibling)}while(u-->0);y.barTopParent=v;return v},barHandleFreeze:{top:function(t){if(f.isBusy()){return false}if(!(f.scrolledTo().end.col<=f.frozenAt().col+1)){return false}f.obj.barHelper().remove();var q=f.obj.barTop(f.frozenAt().col+1),s=q.position(),r=d(k.createElement("div")).addClass(f.cl.uiBarHandleFreezeTop+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeTop).height(p.colMargin+p.boxModelCorrection).css("top",s.top+"px").css("left",s.left+"px").attr("title",f.msg.dragToFreezeCol).prependTo(t);f.controls.bar.helper[f.i]=f.obj.barHelper().add(r);f.controls.bar.x.handleFreeze[f.i]=r;f.draggable(r,{axis:"x",start:function(){f.setBusy(true)},stop:function(w,u){f.setBusy(false);f.setDirty(true);var v=f.nearest(r,f.controls.bar.x.tds());f.obj.barHelper().remove();f.frozenAt().col=f.getTdLocation(v).col-1;f.evt.scroll.start("x",t)},containment:"parent"})},left:function(t){if(f.isBusy()){return false}if(!(f.scrolledTo().end.row<=(f.frozenAt().row+1))){return false}f.obj.barHelper().remove();var q=f.obj.barLeft(f.frozenAt().row+1),s=q.position(),r=d(k.creteElement("div")).addClass(f.cl.uiBarHandleFreezeLeft+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeLeft).width(p.colMargin).css("top",s.top+"px").css("left",s.left+"px").attr("title",f.msg.dragToFreezeRow).prependTo(t);f.controls.bar.helper[f.i]=f.obj.barHelper().add(r);f.controls.bar.y.handleFreeze[f.i]=r;f.draggable(r,{axis:"y",start:function(){f.setBusy(true)},stop:function(w,u){f.setBusy(false);f.setDirty(true);var v=f.nearest(r,f.controls.bar.y.tds());f.obj.barHelper().remove();f.frozenAt().row=f.getTdLocation(v).row-1;f.evt.scroll.start("y",t)},containment:"parent"})},corner:function(){}},makeMenu:function(s,q){var u,r=d([]);switch(s){case"top":u=d(k.createElement("div")).addClass(f.cl.uiMenu+" "+f.cl.menu);f.controls.bar.x.menu[f.i]=u;break;case"left":u=d(k.createElement("div")).addClass(f.cl.uiMenu+" "+f.cl.menu);f.controls.bar.y.menu[f.i]=u;break;case"cell":u=d(k.createElement("div")).addClass(f.cl.uiMenu+" "+f.cl.menu);f.controls.tdMenu[f.i]=u;break}u.mouseleave(function(){u.hide()}).bind("contextmenu",function(){return false}).appendTo(b).hide().disableSelectionSpecial();for(var t in q){if(q[t]){if(d.isFunction(q[t])){r=r.add(d("<div />").text(t).data("msg",t).click(function(){q[d(this).data("msg")].apply(this,[f]);return false}).appendTo(u).hover(function(){r.removeClass("ui-state-highlight");d(this).addClass("ui-state-highlight")},function(){d(this).removeClass("ui-state-highlight")}))}else{if(q[t]=="line"){d("<hr />").appendTo(u)}}}}return u},barMenu:{top:function(s,q,r){if(f.isBusy()){return false}var u=f.obj.barMenuTop().hide();if(!u.length){u=f.controlFactory.makeMenu("top",p.contextmenuTop)}if(!r){u.css("left",(s.pageX-5)+"px").css("top",(s.pageY-5)+"px").show();return u}var t=f.obj.barMenuParentTop().hide();if(!t.length){t=d(k.createElement("div")).addClass(f.cl.uiBarMenuTop+" "+f.cl.barHelper).append(d(k.createElement("span")).addClass("ui-icon ui-icon-triangle-1-s")).mousedown(function(v){t.parent().mousedown().mouseup();var w=t.offset();u.css("left",(v.pageX-5)+"px").css("top",(v.pageY-5)+"px").show()}).blur(function(){if(u){u.hide()}}).css("padding-left",r.position().left+r.width()-p.colMargin).bind("destroy",function(){t.remove();f.controls.bar.x.menuParent[f.i]=null});f.controls.bar.x.menuParent[f.i]=t}t.prependTo(r).show()},left:function(r,q){if(f.isBusy()){return false}f.obj.barMenuLeft().hide();if(q){f.obj.barHandleFreezeLeft().remove()}var s;s=f.obj.barMenuLeft();if(!s.length){s=f.controlFactory.makeMenu("left",p.contextmenuLeft)}s.css("left",(r.pageX-5)+"px").css("top",(r.pageY-5)+"px").show();return true},corner:function(){}},tdMenu:function(q){if(f.isBusy()){return false}f.obj.tdMenu().hide();var r=f.obj.tdMenu();if(!r.length){r=f.controlFactory.makeMenu("cell",p.contextmenuCell)}r.css("left",(q.pageX-5)+"px").css("top",(q.pageY-5)+"px").show()},header:function(){f.obj.header().remove();f.obj.tabContainer().remove();var x=k.createElement("div"),s=k.createElement("table"),v=k.createElement("tr"),A,t,B=k.createElement("td"),C,u,r,y,q;x.appendChild(s);s.appendChild(v);x.className=f.cl.header+" "+f.cl.uiControl;f.controls.header=d(x);if(p.title){if(d.isFunction(p.title)){p.title=f.title(f,l)}B.className=f.cl.title;f.controls.title=d(B).html(p.title)}v.appendChild(B);function z(D){if(d.isFunction(D)){D=d(D(f))}else{D=d(D)}if(D.is("ul")){D.find("ul").hide().addClass(f.cl.uiMenuUl);D.find("li").addClass(f.cl.uiMenuLi).hover(function(){d(this).find("ul:first").hide().show()},function(){d(this).find("ul:first").hide()})}return D}if(f.isSheetEditable()){if(p.menuLeft){u=k.createElement("td");u.className=f.cl.menu+" "+f.cl.menuFixed;v.insertBefore(u,B);f.controls.menuLeft[f.i]=d(u).append(z(p.menuLeft));f.controls.menuLeft[f.i].find("img").load(function(){f.sheetSyncSize()})}if(p.menuRight){r=k.createElement("td");r.className=f.cl.menu+" "+f.cl.menuFixed;v.appendChild(r);f.controls.menuRight[f.i]=d(r).append(z(p.menuRight));f.controls.menuRight[f.i].find("img").load(function(){f.sheetSyncSize()})}C=k.createElement("td");C.className=f.cl.label;f.controls.label=d(C);y=k.createElement("textarea");y.className=f.cl.formula;y.onkeydown=f.evt.keydownHandler.formulaKeydown;y.onkeyup=function(){f.obj.inPlaceEdit().val(this.value)};y.onchange=function(){f.obj.inPlaceEdit().val(this.value)};y.onpaste=f.evt.pasteOverCells;y.onfocus=function(){f.setNav(false)};y.onfocusout=function(){f.setNav(true)};y.onblur=function(){f.setNav(true)};f.controls.formula=d(y);var w=k.createElement("span");w.appendChild(y);A=k.createElement("table");t=k.createElement("tr");A.appendChild(t);x.appendChild(A);q=k.createElement("td");q.className=f.cl.formulaParent;q.appendChild(w);t.appendChild(C);t.appendChild(q);f.resizableSheet(d(w),{minHeight:f.controls.formula.height(),maxHeight:78,handles:"s",resize:function(E,D){f.controls.formula.height(D.size.height);f.sheetSyncSize()}});d.sheet.instance.each(function(){this.nav=false});f.setNav(true);c.keydown(f.evt.keydownHandler.documentKeydown)}return x},ui:function(){var q=k.createElement("div");q.setAttribute("class",f.cl.ui);f.controls.ui=d(q);return q},tabContainer:function(){var q=f.controls.tabContainer=d(k.createElement("span")).addClass(f.cl.tabContainer).mousedown(function(u){var t=u.target.i;if(t>=0){f.trigger("sheetSwitch",[t])}return false}).dblclick(function(u){var t=u.target.i;if(t>=0){f.trigger("sheetRename",[t])}return false});if(f.isSheetEditable()){var r=k.createElement("span");r.setAttribute("class",f.cl.tab+" "+f.cl.uiTab+" ui-corner-bottom");r.setAttribute("title",f.msg.addSheet);r.innerHTML="&nbsp;+&nbsp;";r.onmousedown=function(){f.addSheet({rows:25,cols:10});return false};r.i=-1;q=q.add(r);if(d.fn.sortable){var s;q.sortable({placeholder:"ui-state-highlight",axis:"x",forceHelperSize:true,forcePlaceholderSize:true,opacity:0.6,start:function(u,t){s=t.item.index();f.trigger("sheetTabSortStart",[u,t])},update:function(u,t){f.trigger("sheetTabSortUpdate",[u,t,s])}})}}else{q.append(k.createElement("span"))}return q},scrollUI:function(v,r,z){var B=0,A=0,t=k.createElement("div"),u=k.createElement("div"),s=k.createElement("style"),q=k.createElement("style");t.setAttribute("class",f.cl.scroll);t.appendChild(u);t.onscroll=function(){if(!f.isBusy()){f.evt.scroll.scrollTo({axis:"x",pixel:t.scrollLeft},0);f.evt.scroll.scrollTo({axis:"y",pixel:t.scrollTop},0);f.autoFillerGoToTd()}};t.onmousedown=function(){f.obj.barHelper().remove()};f.controls.scroll[f.i]=d(t).disableSelectionSpecial();f.controls.scrolls=f.obj.scrolls().add(t);s.updateStyle=function(x,E){x=x||[];if(x.length==B){return}B=x.length;var y=E||o.nthCss("col","#"+f.id.table+f.i,this,x,f.frozenAt().col+1)+o.nthCss("td","#"+f.id.table+f.i+" tr",this,x,f.frozenAt().col+1);if(this.styleSheet){this.styleSheet.cssText=y}else{this.innerHTML=y}f.scrolledTo();f.scrolledArea[f.i].start.col=j.max(x.pop()||1,1);f.scrolledArea[f.i].end.col=j.max(x.shift()||1,1);f.obj.barHelper().remove()};s.touch=function(){if(this.styleSheet){this.styleSheet.cssText+=" "}else{this.innerHTML+=" "}};q.updateStyle=function(x,E){x=x||[];if(x.length==A){return}A=x.length;var y=E||o.nthCss("tr","#"+f.id.table+f.i,this,x,f.frozenAt().row+1);if(this.styleSheet){this.styleSheet.cssText=y}else{this.innerHTML=y}f.scrolledTo();f.scrolledArea[f.i].start.row=j.max(x.pop()||1,1);f.scrolledArea[f.i].end.row=j.max(x.shift()||1,1);f.obj.barHelper().remove()};f.controls.bar.x.scroll[f.i]=s;f.controls.bar.y.scroll[f.i]=q;var w,D;function C(x){if(x&&x.styleSheet){return x.styleSheet.cssText}return x.innerText}r.appendChild(s);r.appendChild(q);r.resizeScroll=function(){w=C(s);D=C(q);s.updateStyle();q.updateStyle();u.setAttribute("style","width:"+z.clientWidth+"px;height:"+z.clientHeight+"px;");u.style.height=z.clientHeight+"px";u.style.width=z.clientWidth+"px";t.style.height=v.clientHeight+"px";t.style.width=v.clientWidth+"px";f.evt.scroll.start("x",r,z,s);f.evt.scroll.start("y",r,z,q);s.updateStyle(null,w);q.updateStyle(null,D)};if(!d.fn.mousewheel){return t}d(r).mousewheel(function(I){var M=I.originalEvent,I,F=function(y,x){return 0!=y%x?y:y/x};if("mousewheel"==M.type){var N=1,G=F(-M.wheelDelta,N),L,J;if(M.wheelDeltaX!==n){t.scrollTop+=F(-M.wheelDeltaY,N);t.scrollLeft+=F(-M.wheelDeltaX,N)}else{t.scrollTop+=G}}else{I=M.detail,100<I?I=3:-100>I&&(I=-3);var K=0,H=0;switch(I){case 1:case -1:H=I*50;break;case 3:case -3:K=I*15;break}t.scrollTop+=K;t.scrollLeft+=H}return false});return t},hide:function(t,s,u){s=s||f.obj.pane();var x=k.createElement("style"),w=k.createElement("style"),q,v;x.updateStyle=function(A){var z=o.nthCss("col","#"+f.id.table+f.i,this,f.toggleHide.hiddenColumns[f.i],0)+o.nthCss("td","#"+f.id.table+f.i+" tr",this,f.toggleHide.hiddenColumns[f.i],0);if(this.styleSheet){this.styleSheet.cssText=z}else{this.innerHTML=z}f.autoFillerGoToTd()};w.updateStyle=function(A){var z=o.nthCss("tr","#"+f.id.table+f.i,this,f.toggleHide.hiddenRows[f.i],0);if(this.styleSheet){this.styleSheet.cssText=z}else{this.innerHTML=z}f.autoFillerGoToTd()};f.controls.toggleHide.x[f.i]=d(x);f.controls.toggleHide.y[f.i]=d(w);s.appendChild(x);s.appendChild(w);p.hiddenColumns[f.i]=p.hiddenColumns[f.i]||[];p.hiddenRows[f.i]=p.hiddenRows[f.i]||[];if(!p.hiddenColumns[f.i].length||!p.hiddenRows[f.i].length){q=u.attributes["data-hiddenrows"]||{value:""};v=u.attributes["data-hiddencolumns"]||{value:""};p.hiddenRows[f.i]=arrHelpers.toNumbers(q.value.split(","));p.hiddenColumns[f.i]=arrHelpers.toNumbers(v.value.split(","))}if(f.s.hiddenRows[f.i]){for(var y in f.s.hiddenRows[f.i]){f.toggleHide.row(f.s.hiddenRows[f.i][y])}}if(p.hiddenColumns[f.i]){for(var r in p.hiddenColumns[f.i]){f.toggleHide.column(p.hiddenColumns[f.i][r])}}},sheetUI:function(w,x,t){if(!t){f.sheetCount=1;f.i=0}else{f.sheetCount++;f.i=t}f.tuneTableForSheetUse(x);f.readOnly[t]=x.className.match("readonly");var u=f.controlFactory.enclosure(x),r=u.pane,q=d(r);w.appendChild(u);f.controlFactory.barTop(x);f.controlFactory.barLeft(x);r.appendChild(x);if(f.isSheetEditable()){var s=f.controlFactory.autoFiller();if(s){r.appendChild(s)}}f.sheetTab(true);if(f.isSheetEditable()){var v=f.obj.formula(),y="";r.onmousedown=function(z){z=z||h.event;z.target=z.target||z.srcElement;f.setNav(true);if(f.isBusy()){return false}if(f.isCell(z.target)){if(z.button==2){paneContextmenuEvent(z)}f.evt.cellOnMouseDown(z);return false}if(f.isBar(z.target)){if(z.button==2){paneContextmenuEvent(z)}y=z.target.entity;f.evt.barInteraction.select(z.target);return false}};r.onmouseup=function(){y=""};r.onmouseover=function(C){C=C||h.event;C.target=C.target||C.srcElement;if(f.isBusy()){return false}if(!f.isBar(C.target)){return false}var B=d(C.target),z=C.target.entity,A=f.getBarIndex[z](C.target);if(A<0){return false}if(f.evt.barInteraction.selecting&&z==y){f.evt.barInteraction.last=A;f.cellSetActiveBar(z,f.evt.barInteraction.first,f.evt.barInteraction.last)}else{f.resizeBar[z](B,A,r,x);if(f.isSheetEditable()){f.controlFactory.barHandleFreeze[z](r);if(z=="top"){f.controlFactory.barMenu[z](C,A,B)}}}};r.ondblclick=f.evt.cellOnDblClick;q.bind("contextmenu",function(B){B.preventDefault();if(f.isBusy()){return false}if(f.isBar(B.target)){var z=B.target.entity,A=f.getBarIndex[z](B.target);if(A<0){return false}if(f.evt.barInteraction.first==f.evt.barInteraction.last){f.controlFactory.barMenu[z](B,A)}}else{f.controlFactory.tdMenu(B)}return false}).disableSelectionSpecial().bind("cellEdit",f.evt.cellEdit)}f.themeRoller.start(x);f.resizableSheet(p.parent,{minWidth:p.width*0.1,minHeight:p.height*0.1,start:function(){u.hide()},stop:function(){u.show();p.width=p.parent.width();p.height=p.parent.height();r.resizeScroll()}});f.createSpreadsheet(x,f.i);f.checkMinSize(x);f.controlFactory.tab();f.controlFactory.hide(u,r,x);f.setChanged(true);return x},enclosure:function(q){var s=k.createElement("div"),r=k.createElement("div");r.scollUI=f.controlFactory.scrollUI(r,s,q);r.appendChild(r.scollUI);s.setAttribute("class",f.cl.pane+" "+f.cl.uiPane);r.appendChild(s);r.setAttribute("class",f.cl.enclosure);r.pane=s;r.table=q;s.table=q;s.enclosure=r;q.pane=s;q.enclosure=r;f.controls.pane[f.i]=s;f.controls.panes=f.obj.panes().add(s);f.controls.enclosure[f.i]=d(r);f.controls.enclosures=f.obj.enclosures().add(r);return r},tab:function(){var q=k.createElement("span"),r=f.controls.tab[f.i]=d(q).appendTo(f.obj.tabContainer());q.setAttribute("class",f.cl.tab);q.innerHTML=f.sheetTab(true);q.i=f.i;q.setAttribute("class",f.cl.uiTab+" ui-corner-bottom");f.controls.tabs=f.obj.tabs().add(r);return q},inPlaceEdit:function(s,v){s=s||f.obj.tdActive();if(!s.length){s=d(f.rowTds(null,1)[1]);f.cellEdit(s)}f.obj.inPlaceEdit().trigger("destroy");var y=f.obj.formula(),t=s.offset(),q=s.attr("style"),A=s.width(),x=s.height(),r=y.val(),z,u;if(!t){return}z=k.createElement("textarea");u=d(z);z.i=f.i;z.value=y[0].value;z.className=f.cl.inPlaceEdit+" "+f.cl.uiInPlaceEdit;z.setAttribute("style","left:"+t.left+"px;top:"+t.top+"px;width:"+A+"px;height:"+x+"px;");z.onkeydown=f.evt.inPlaceEditOnKeyDown;z.onkeyup=function(){y[0].value=z.value};z.onchange=function(){y[0].value=z.value};z.onfocus=function(){f.setNav(false)};z.onfocusout=function(){f.setNav(true)};z.onblur=function(){f.setNav(true)};b.append(z);f.controls.inPlaceEdit[f.i]=u.bind("paste",f.evt.pasteOverCells).focus().bind("destroy",function(){f.cellLast.isEdit=(z.value!=r);u.remove();f.controls.inPlaceEdit[z.i]=false});if(!v){u.select()}if(d.fn.elastic){u.elastic()}},autoFiller:function(){if(!p.autoFiller){return null}var r=k.createElement("div"),q=k.createElement("div"),s=k.createElement("div");r.className=f.cl.autoFiller+" "+f.cl.uiAutoFiller;q.className=f.cl.autoFillerHandle;s.className=f.cl.autoFillerCover;r.onmousedown=function(){var u=f.obj.tdActive();if(u){var t=f.getTdLocation(u);f.cellSetActive(u,t,true,f.autoFillerNotGroup,function(){var w=f.highlighted(),v=f.getTdLocation(w.first());f.fillUpOrDown(v.row<t.row||v.col<t.col);f.autoFillerGoToTd(w.last());f.autoFillerNotGroup=false})}};f.controls.autoFiller[f.i]=d(r);return r}},autoFillerNotGroup:true,updateCellsAfterPasteToFormula:function(z){var y=0,x=f.obj.formula(),B=new Date();z=z||x.val();var w={row:f.cellLast.row,col:f.cellLast.col},r=x.val(),t=r;if(w.row==0&&w.col==0){return false}var C=tsv.parse(":::::"+r);if(!d.isArray(C)){x.val(C);f.fillUpOrDown(false,C);return true}for(var v=0;v<C.length;v++){f.cellLast.isEdit=true;var q=C[v];for(var u=0;u<q.length;u++){y++;var s=f.getTd(f.i,v+w.row,u+w.col);s.row=w.row;s.col=w.col;if(s.length){if(!f.spreadsheets[f.i]||!f.spreadsheets[f.i][v+w.row]||!f.spreadsheets[f.i][v+w.row][u+w.col]){continue}var A=f.spreadsheets[f.i][v+w.row][u+w.col];if(A){p.parent.one("sheetPreCalculation",function(){if((q[u]+"").charAt(0)=="="){A.formula=q[u].substring(1);A.value="";s.data("formula",q[u])}else{A.formula="";A.value=q[u];s.removeData("formula")}});f.calcDependencies.apply(A);if(v==0&&u==0){t=q[u]}}}}}if(r!=t){x.val(t)}f.fillUpOrDown(false,t);f.evt.cellEditDone(true)},evt:{keydownHandler:{enterOnInPlaceEdit:function(q){if(!q.shiftKey){return f.evt.cellSetActiveFromKeyCode(q)}else{return true}},enter:function(q){if(!f.cellLast.isEdit&&!q.ctrlKey){f.obj.tdActive().dblclick();return false}else{return this.enterOnInPlaceEdit(q)}},tab:function(q){return f.evt.cellSetActiveFromKeyCode(q)},findCell:function(q){if(q.ctrlKey){f.cellFind();return false}return true},redo:function(q){if(q.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo();return false}return true},undo:function(q){if(q.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo(true);return false}return true},copy:function(u,r){var t=f.highlighted(true),v=f.obj.formula(),s=v.val(),q=f.tdsToTsv(t,r);v.val(q).focus().select();c.one("keyup",function(){if(r){v.val("")}else{v.val(s)}});return true},cut:function(q){return this.copy(q,true)},pageUpDown:function(q){var t=f.sheetSize(),x=f.obj.pane(),s=x.clientHeight,u=0,v=0,w;if(q){for(var r=f.cellLast.row;r>0&&u<s;r--){w=f.getTd(f.i,r,1);if(!w.data("hidden")&&w.is(":hidden")){w.show()}u+=w.parent().height()}}else{for(var r=f.cellLast.row;r<t.rows&&u<s;r++){w=f.getTd(f.i,r,1);u+=w.parent().height()}}f.cellEdit(w);return false},formulaKeydown:function(q){q=q||h.event;if(f.readOnly[f.i]){return false}if(f.cellLast.row<0||f.cellLast.col<0){return false}f.trigger("sheetFormulaKeydown",[false]);switch(q.keyCode){case key.C:if(q.ctrlKey){return f.evt.keydownHandler.copy(q)}else{f.obj.tdActive().dblclick();return true}case key.X:if(q.ctrlKey){return f.evt.keydownHandler.cut(q)}else{f.obj.tdActive().dblclick();return true}case key.Y:if(q.ctrlKey){f.evt.keydownHandler.redo(q);return false}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.Z:if(q.ctrlKey){f.evt.keydownHandler.undo(q);return false}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.ESCAPE:f.evt.cellEditAbandon();break;case key.ENTER:f.evt.cellSetActiveFromKeyCode(q);return false;break;default:f.cellLast.isEdit=true}},formulaKeydownIf:function(r,q){if(r){f.obj.tdActive().dblclick();return true}return false},documentKeydown:function(q){if(f.readOnly[f.i]){return false}if(f.cellLast.row<0||f.cellLast.col<0){return false}if(f.nav){switch(q.keyCode){case key.DELETE:f.tdsToTsv(null,true);f.obj.formula().val("");break;case key.TAB:f.evt.keydownHandler.tab(q);break;case key.ENTER:f.evt.cellSetActiveFromKeyCode(q);break;case key.LEFT:case key.UP:case key.RIGHT:case key.DOWN:(q.shiftKey?f.evt.cellSetHighlightFromKeyCode(q):f.evt.cellSetActiveFromKeyCode(q));break;case key.PAGE_UP:f.evt.keydownHandler.pageUpDown(true);break;case key.PAGE_DOWN:f.evt.keydownHandler.pageUpDown();break;case key.HOME:case key.END:f.evt.cellSetActiveFromKeyCode(q);break;case key.V:if(q.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(!f.evt.pasteOverCells(q),q)}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.Y:if(q.ctrlKey){f.evt.keydownHandler.redo(q);return false}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.Z:if(q.ctrlKey){f.evt.keydownHandler.undo(q);return false}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.ESCAPE:f.evt.cellEditAbandon();break;case key.F:if(q.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(f.evt.keydownHandler.findCell(q),q)}else{f.obj.tdActive().trigger("cellEdit");return true}break;case key.CAPS_LOCK:case key.SHIFT:case key.ALT:break;case key.CONTROL:f.obj.formula().focus().select();return true;break;default:f.obj.tdActive().trigger("cellEdit");return true;break}return false}}},pasteOverCells:function(s){s=s||h.event;if(s.ctrlKey||s.type=="paste"){var r=function(){f.updateCellsAfterPasteToFormula()};var q=c.one("keyup",function(){r();r=function(){};q.mouseup()}).one("mouseup",function(){r();r=function(){};q.keyup()});f.setDirty(true);f.setChanged(true);return true}},inPlaceEditOnKeyDown:function(q){q=q||h.event;f.trigger("sheetFormulaKeydown",[true]);switch(q.keyCode){case key.ENTER:return f.evt.keydownHandler.enterOnInPlaceEdit(q);break;case key.TAB:return f.evt.keydownHandler.tab(q);break;case key.ESCAPE:f.evt.cellEditAbandon();return false;break}},cellEditDone:function(s){f.obj.inPlaceEdit().trigger("destroy");if(f.cellLast.isEdit||s){var u=f.obj.formula(),t=f.obj.tdActive();if(f.isFormulaEditable(t)){if(t&&f.cellLast.row>0&&f.cellLast.col>0){var r=u.val(),q=t[0].jSCell;if(!q.edited){q.edited=true;f.controls.cellsEdited[f.i]=f.obj.cellsEdited().add(q)}p.parent.one("sheetPreCalculation",function(){if(r.charAt(0)=="="){t.data("formula",r);q.value=r;q.formula=r}else{t.removeData("formula");q.value=r;q.formula=""}});f.calcDependencies.apply(q);f.cellLast.isEdit=false;f.trigger("sheetCellEdited",[q])}}}},cellEditAbandon:function(q){f.obj.inPlaceEdit().trigger("destroy");f.themeRoller.bar.clearActive();f.themeRoller.cell.clearHighlighted(null,true);if(!q){f.calc()}f.cellLast.td=d([]);f.cellLast.row=0;f.cellLast.col=0;f.rowLast=0;f.colLast=0;f.highlightedLast.start={row:0,col:0};f.highlightedLast.end={row:0,col:0};f.labelUpdate("",true);f.obj.formula().val("").blur();f.autoFillerHide();return false},cellSetFocusFromXY:function(r,q){var s=f.getTdFromXY(r,q);if(s.type=="cell"){s=d(s);f.cellEdit(s);return false}return true},cellSetHighlightFromKeyCode:function(t){var s=f.highlightedLastOrdered(),r=f.sheetSize(),w=f.obj.tdActive(),u=f.getTdLocation(w),v=s.start,q=s.end;switch(t.keyCode){case key.UP:if(s.start.row<u.row){v.row=s.start.row;v.row--;v.row=j.max(v.row,1);break}q.row=s.end.row;q.row--;q.row=j.max(q.row,1);break;case key.DOWN:if(s.start.row<=v.row){v.row=s.start.row;v.row++;v.row=j.min(v.row,r.rows);break}q.row=s.end.row;q.row++;q.row=j.min(q.row,r.rows);break;case key.LEFT:if(s.start.col<u.col){v.col=s.start.col;v.col--;v.col=j.max(v.col,1);break}q.col=s.end.col;q.col--;q.col=j.max(q.col,1);break;case key.RIGHT:if(s.start.col<u.col){v.col=s.start.col;v.col++;v.col=j.min(v.col,r.cols);break}q.col=s.end.col;q.col++;q.col=j.min(q.col,r.cols);break}f.highlightedLast.start=v;f.highlightedLast.end=q;f.cycleCellArea(function(x){f.themeRoller.cell.setHighlighted(x.td)},v,q);return false},cellSetActiveFromKeyCode:function(t){var u={row:f.cellLast.row,col:f.cellLast.col},s=false,r,q=false;switch(t.keyCode){case key.UP:u.row--;break;case key.DOWN:u.row++;break;case key.LEFT:u.col--;break;case key.RIGHT:u.col++;break;case key.ENTER:u=f.evt.incrementAndStayInGrid(f.highlightedLastOrdered(),u,"row","col",t.shiftKey);s=true;r=f.highlighted();if(r.length>1){q=true}else{u.row+=(t.shiftKey?-1:1);if(p.autoAddCells&&u.row>f.sheetSize().rows){f.controlFactory.addRow()}}break;case key.TAB:u=f.evt.incrementAndStayInGrid(f.highlightedLastOrdered(),u,"col","row",t.shiftKey);s=true;r=f.highlighted();if(r.length>1){q=true}else{u.col+=(t.shiftKey?-1:1);if(p.autoAddCells&&u.col>f.sheetSize().cols){f.controlFactory.addColumn()}}break;case key.HOME:u.col=1;break;case key.END:u.col=f.obj.tdActive().parent().children("td").length-1;break}u.col=u.col||1;u.row=u.row||1;if(!f.cellLast.isEdit||s){var v=f.getTd(f.i,u.row,u.col);if(v){f.cellEdit(v,null,q);return false}}return true},incrementAndStayInGrid:function(t,u,r,q,s){if(s){u[r]--;if(u[r]<t.start[r]){u[r]=t.end[r];u[q]--}if(u[q]<t.start[q]){u[q]=t.end[q]}}else{u[r]++;if(u[r]>t.end[r]){u[r]=t.start[r];u[q]++}if(u[q]>t.end[q]){u[q]=t.start[q]}}return u},cellOnMouseDown:function(q){f.obj.formula().blur();if(q.shiftKey){f.getTdRange(q,f.obj.formula().val())}else{f.cellEdit(d(q.target),true)}},cellOnDblClick:function(q){if(f.isBusy()){return false}f.controlFactory.inPlaceEdit(null,true)},cellEdit:function(q){if(f.isBusy()){return false}f.controlFactory.inPlaceEdit()},barInteraction:{first:0,last:0,selecting:false,select:function(s){if(!s){return}if(!s.type=="bar"){return}var q=s.entity,r=f.getBarIndex[q](s);if(r<0){return false}f[q+"Last"]=r;f.evt.barInteraction.last=f.evt.barInteraction.first=r;f.cellSetActiveBar(q,f.evt.barInteraction.first,f.evt.barInteraction.last);f.evt.barInteraction.first=f.evt.barInteraction.last=f[q+"Last"]=r;f.evt.barInteraction.selecting=true;c.one("mouseup",function(){f.evt.barInteraction.selecting=false});return false}},scroll:{axis:{x:{},y:{}},size:{},td:{},start:function(u,z,t,r){f.autoFillerHide();z=z||f.obj.pane();t=t||f.obj.table();var v=f.evt.scroll;v.size=f.sheetSize(t);v.td=f.obj.tdActive();v.axis[u].v=[];v.axis[u].p=[];switch(u||"x"){case"x":var q=v.axis.x;q.max=v.size.cols;q.min=1;r.updateStyle();q.scrollStyle=r;q.area=z.clientWidth;q.sheetArea=t.clientWidth;q.scrollUpdate=function(x){x=x||f.obj.scroll();x.scrollLeft(q.value*(x.width()/v.size.cols));return};break;case"y":var w=v.axis.y;w.max=v.size.rows;w.min=1;r.updateStyle();w.scrollStyle=r;w.area=z.clientHeight;w.sheetArea=t.clientHeight;w.scrollUpdate=function(x){x=x||f.obj.scroll();x.scrollTop(w.value*(x.height()/v.size.rows));return};break}v.axis[u].gridSize=100/(v.axis[u].max-v.axis[u].min);for(var s=v.axis[u].min;s<=v.axis[u].max;s++){v.axis[u].v[s]=v.axis[u].gridSize*s;v.axis[u].p[v.axis[u].gridSize*s]=s+1}},scrollTo:function(t){t=t||{};t.axis=t.axis||"x";t.value=t.value||0;t.pixel=t.pixel||1;if(!f.evt.scroll.axis){f.evt.scroll.start(t.axis)}var s=f.evt.scroll.axis[t.axis];if(!t.value){if(!s.p){return}t.value=s.p[arrHelpers.closest(s.v,Math.abs(t.pixel/(s.sheetArea-s.area))*100,s.min)]}t.max=t.max||s.max;var r=((t.value>t.max?t.max:t.value)-s.min)-1,q=[];if(r>0){do{q.push(r+s.min)}while(r--)}if(q.length){if(s.scrollStyle){s.scrollStyle.updateStyle(q)}}else{if(s.scrollStyle){s.scrollStyle.updateStyle()}}s.value=t.value},stop:function(){if(this.axis.x.scrollUpdate){this.axis.x.scrollUpdate()}if(this.axis.y.scrollUpdate){this.axis.y.scrollUpdate()}if(f.evt.scroll.td){f.evt.scroll.td=null;f.autoFillerGoToTd()}}}},refreshColumnLabels:function(s){s=s||0;f.obj.barMenuParentTop().trigger("destroy");var r=f.controls.bar.x.td[f.i];if(!r){return}for(var q=s;q<r.length;q++){if(q){r[q].text(jSE.columnLabelString(r[q][0].cellIndex))}}},refreshRowLabels:function(s){s=s||0;var r=f.controls.bar.y.td[f.i];if(!r){return}for(var q=s;q<r.length;q++){if(q){d(r[q]).text(r[q][0].parentNode.rowIndex)}}},isCell:function(q){if(q&&q.tagName&&q.tagName=="TD"&&q.type&&q.type=="cell"){return true}return false},isBar:function(q){if(q&&q.tagName&&q.tagName=="TD"&&q.type&&q.type=="bar"){return true}return false},readOnly:[],isSheetEditable:function(q){q=q||f.i;return(p.editable==true&&!f.readOnly[q])},isFormulaEditable:function(q){if(p.lockFormulas){if(q.data("formula")!==n){return false}}return true},toggleFullScreen:function(){if(!f){return}f.evt.cellEditDone();var r=f.obj.fullScreen();if(r.is(":visible")){b.removeClass("bodyNoScroll");p.parent=r.data("parent");var q=p.parent.width(),t=p.parent.height();p.width=q;p.height=t;p.parent.append(r.children());r.remove();f.sheetSyncSize();f.obj.pane().resizeScroll();f.trigger("sheetFullScreen",[false])}else{b.addClass("bodyNoScroll");var q=a.width()-15,t=a.height()-15,s=p.parent;p.width=q;p.height=t;p.parent=f.controls.fullScreen[f.i]=d('<div class="'+f.cl.fullScreen+" "+f.cl.uiFullScreen+'" />').append(p.parent.children()).appendTo(b).data("parent",p.parent);f.obj.pane().resizeScroll();f.sheetSyncSize();s.trigger("sheetFullScreen",[true])}},renameSheet:function(q){if(isNaN(q)){return false}if(q>-1){f.sheetTab()}},switchSheet:function(q){if(isNaN(q)){return false}if(q==-1){f.addSheet("5x10")}else{if(q!=f.i){f.setActiveSheet(q);f.calc(q)}}},tuneTableForSheetUse:function(s){var r=d(s);f.controls.table[f.i]=r.addClass(f.cl.table).addClass(f.cl.uiTable).attr("id",f.id.table+f.i).attr("border","1px").attr("cellpadding","0").attr("cellspacing","0");f.formatTable(s);f.sheetDecorateRemove(false,r);f.controls.tables=f.obj.tables().add(s);var t=r.data("frozenatrow"),q=r.data("frozenatcol");if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0}}if(t){f.s.frozenAt[f.i].row=t}if(q){f.s.frozenAt[f.i].col=q}},createSpreadsheet:function(s,r){s=s||f.obj.table();r=r||f.i;f.spreadsheets[r]=[];var t=f.rows(s),u=t.length-1,q;if(u<0){return}do{q=t[u].children.length-1;if(q<0){return}do{var v=t[u].children[q];if(u>0&&q>0){f.createCell(r,u,q)}else{if(q==0&&u>0){v.type="bar";v.entity="left";v.innerHTML=u;v.className=f.cl.barLeft+" "+f.cl.barLeft+"_"+f.i+" "+f.cl.uiBar}if(u==0&&q>0){v.type="bar";v.entity="top";v.innerHTML=jSE.columnLabelString(q);v.className=f.cl.barTop+" "+f.cl.barTop+"_"+f.i+" "+f.cl.uiBar}if(u==0&&q==0){v.type="bar";v.entity="corner";v.className=f.cl.uiBar+"  "+f.cl.barCorner;f.controls.bar.corner[f.i]=v}}}while(q--)}while(u--)},toggleHide:{hiddenRows:[],row:function(r){r=r||f.rowLast;if(!r){return}var t=f.rows()[r],q=d(t),s=[];if(!this.hiddenRows[f.i]){this.hiddenRows[f.i]=[]}if(q.length&&d.inArray(r+1,this.hiddenRows[f.i])<0){this.hiddenRows[f.i].push(r+1)}else{this.hiddenRows[f.i].splice(this.hiddenRows[f.i].indexOf(r+1),1)}f.obj.toggleHideStyleY()[0].updateStyle()},rowShowAll:function(){d.each(this.hiddenRows[f.i],function(q){d(this).removeData("hidden")});f.obj.toggleHideStyleY().html("");this.hiddenRows[f.i]=[]},hiddenColumns:[],columnIndexOffset:[],column:function(r){r=r||f.colLast;if(!r){return}var q=f.cols()[r],t=d(q),s=[];if(!this.hiddenColumns[f.i]){this.hiddenColumns[f.i]=[]}if(t.length&&d.inArray(r+1,this.hiddenColumns[f.i])<0){this.hiddenColumns[f.i].push(r+1)}else{this.hiddenColumns[f.i].splice(this.hiddenColumns[f.i].indexOf(r+1),1)}f.obj.toggleHideStyleX()[0].updateStyle()},columnShowAll:function(){f.obj.toggleHideStyleX().html("");this.hiddenColumns[f.i]=[]}},merged:[],merge:function(){var t=[],u=f.highlighted(),w=f.getTdLocation(u.first()),y=f.getTdLocation(u.last()),x=0,B=0,z=f.spreadsheets[f.i][w.row][w.col],D=new Date();if(u.length>1&&w.row){f.setDirty(true);f.setChanged(true);if(!f.merged[f.i+"_"+w.row+"_"+w.col]){f.merged[f.i+"_"+w.row+"_"+w.col]=[]}var A=f.merged[f.i+"_"+w.row+"_"+w.col];for(var G=w.row;G<=y.row;G++){if(G){B++}for(var q=w.col;q<=y.col;q++){if(G==w.row){x++}var r=f.getTd(f.i,G,q),C=f.spreadsheets[f.i][G][q],s=f.spreadsheets[f.i][G][w.col-1]||f.spreadsheets[f.i][G][w.col],F=f.spreadsheets[f.i][G][y.col+1]||f.spreadsheets[f.i][G][y.col],v=f.spreadsheets[f.i][y.row-1][y.col]||f.spreadsheets[f.i][y.row][y.col],E=f.spreadsheets[f.i][y.row+1][y.col]||f.spreadsheets[f.i][y.row][y.col];A.push(C);t.push(C.formula?"("+C.formula.substring(1)+")":C.value);p.parent.one("sheetPreCalculation",function(){if(q!=w.col||G!=w.row){C.formula=null;C.value="";C.html="";C.defer=z;C.right=F;C.down=E;C.left=s;C.up=v;r.removeData("formula").html("").hide()}});f.calcDependencies.apply(C)}}z.value=t.join(" ");z.formula=(z.formula?t.join(" "):"");u.first().show().attr("rowSpan",B).attr("colSpan",x);f.calcDependencies.apply(u.first()[0].jSCell);f.evt.cellEditDone()}},unmerge:function(){var s=f.highlighted().first(),u=f.getTdLocation(s),v=f.spreadsheets[f.i][u.row][u.col],w=s.data("formula"),y=new Date();var q=j.max(s.attr("rowSpan")*1,1);var t=j.max(s.attr("colSpan")*1,1);for(var z=u.row;z<=u.row+q;z++){for(var r=u.col;r<=u.col+t;r++){var s=f.getTd(f.i,z,r).show().removeAttr("colSpan").removeAttr("rowSpan"),x=s.cell;x.up=x.down=x.left=x.right=x.defer=null;f.calcDependencies.apply(x,[y])}}},fillUpOrDown:function(y,A){f.evt.cellEditDone();var C=f.highlighted(true),u=f.obj.tdActive(),z=new Date(),w=f.getTdLocation(C[0].td),D=f.getTdLocation(C[C.length-1].td),q=f.getTdLocation(u),s={row:0,col:0},r=A||u[0].jSCell.value,B=false,t=C.length-1,x=function(){};A=A||u[0].jSCell.value;if(t>=0){if(A.charAt&&A.charAt(0)=="="){if(t>=0){do{if(!y){s.row=q.row-D.row;s.col=q.col-D.col}else{s.row=q.row-w.row;s.col=q.col-w.col}r=f.reparseFormula(A,s);p.parent.one("sheetPreCalculation",function(){C[t].formula=r;C[t].value="";C[t].td.data("formula",r)});f.calcDependencies.apply(C[t],[z])}while(t--);return true}}else{if((B=!isNaN(r))||r.length>0){if(B&&r!=""){r*=1;if(!y){r+=C.length-1}x=function(){r--}}}do{p.parent.one("sheetPreCalculation",function(){C[t].formula="";C[t].value=r;C[t].td.removeData("formula")});f.calcDependencies.apply(C[t],[z]);x()}while(t--)}}return false},tdsToTsv:function(B,t,z){B=B||f.highlighted(true);if(B.type){B=[B]}z=z||function(E,D){if(t){p.parent.one("sheetPreCalculation",function(){D.formula="";D.value=""});f.calcDependencies.apply(D,[y])}};var w=[],A,v,r={},y=new Date(),s=B.length-1,C,q;if(s>=0){A=f.getTdLocation(B[0].td);v=f.getTdLocation(B[B.length-1].td);r.row=j.min(A.row,v.row);r.col=j.min(A.col,v.col);do{var u=f.getTdLocation(B[s].td),x=(B[s].formula?"="+B[s].formula:B[s].value);C=j.abs(u.row-r.row);q=j.abs(u.col-r.col);if(!w[C]){w[C]=[]}if((x+="").match(/\n/)){x='"'+x+'"'}w[C][q]=(x||"");z.apply(B[s].td,[u,B[s]])}while(s-->0);s=w.length-1;do{w[s]=w[s].join("\t")}while(s-->0);return w.join("\n")}return""},offsetFormulas:function(x,w,s){var r=f.sheetSize(),v={first:x,last:{row:r.rows,col:r.cols}},u={first:{row:1,col:1},last:{row:r.rows,col:r.cols}},t=new Date(),q=[];f.cycleCells(function(){var y=this;if(this.formula&&typeof this.formula=="string"&&f.isFormulaEditable(this.td)){this.formula=f.reparseFormula(this.formula,w,x,s);this.td.data("formula","="+this.formula)}q.push(function(){f.calcDependencies.apply(y,[t,true])})},u.first,u.last);while(q.length){q.pop()()}f.evt.cellEditDone()},reparseFormula:function(t,s,r,q){return t.replace(jSE.regEx.cell,function(v,w,A,B){if(w=="SHEET"){return v}s=s||{loc:0,row:0};var u={row:A*1,col:jSE.columnLabelIndex(w)},z,y,x={col:w,row:A};if(r){if(u.col==r.col||w=="#REF!"){x.col="#REF!";x.use=true}if(u.row==r.row||A=="#REF!"){x.row="#REF!";x.use=true}if(x.use){return x.col+x.row}if(q){if(u.col>r.col){z=true}if(u.row>r.row){y=true}}else{if(u.col>r.col){z=true}if(u.row>r.row){y=true}}if(z||y){if(z){u.col+=s.col}if(y){u.row+=s.row}return f.makeFormula(u)}}else{return f.makeFormula(u,s)}return v})},makeFormula:function(r,q){q=d.extend({row:0,col:0},q);r.col+=q.col;r.row+=q.row;if(r.col<0){r.col=0}if(r.row<0){r.row=0}return jSE.parseCellName(r.col,r.row)},cycleCells:function(t,w,u,s){s=s||f.i;w=w||{row:1,col:1};if(!u){var r=f.sheetSize();u={row:r.rows,col:r.cols}}var v=u.row,q;if(v<w.row){return}do{q=u.col;do{t.apply(f.spreadsheets[s][v][q],[s,v,q])}while(q-->w.col)}while(v-->w.row)},cycleCellsAll:function(t){var u=f.i,s,r,q;for(s=0;s<=f.sheetCount;s++){f.i=s;r=f.sheetSize();q={row:r.rows,col:r.cols};f.cycleCells(t,{row:0,col:0},q,s)}f.i=u},cycleCellArea:function(w,y,v,u){var q={start:{},end:{}},z,s,x,t=f.i,r={cell:d([]),td:d([])};if(u){q.start=y;q.end=v}else{q.start.row=j.max(j.min(y.row,v.row),1);q.start.col=j.max(j.min(y.col,v.col),1);q.end.row=j.max(y.row,v.row,1);q.end.col=j.max(y.col,v.col,1)}z=q.end.row;do{s=q.end.col;do{x=f.spreadsheets[t][z][s];r.cell=r.cell.add(x);r.td=r.td.add(x.td)}while(s-->q.start.col)}while(z-->q.start.row);if(w){w(r)}},formatTable:function(A){var z=p.newColumnWidth,x=p.colMargin,q=A.children,u=q.length-1,t,r,v,s,y;if(u>-1){do{switch(q[u].nodeName){case"TBODY":hasTbody=true;v=q[u];break;case"COLGROUP":hasColgroup=true;s=q[u];break}}while(u--);if(!v){v=k.createElement("tbody");d(q).wrap(v)}if(!s||s.children.length<1){s=k.createElement("colgroup");A.insertBefore(s,v);y=v.children[0];for(u=0,t=y.children.length;u<t;u++){r=k.createElement("col");s.appendChild(r);r.style.width=z+"px";r.width=z+"px"}for(u=0,t=v.children.length;u<t;u++){v.children[u].height=x+"px";v.children[u].style.height=x+"px"}}}A.tbody=v;A.colgroup=s;A.removeAttribute("width");A.style.width=""},checkMinSize:function(s){var r=f.sheetSize(s),t=0,q=0;if(r.cols<p.minSize.cols){f.controlFactory.addColumnMulti(null,p.minSize.cols-r.cols)}if(r.rows<p.minSize.rows){f.controlFactory.addRowMulti(null,p.minSize.rows-r.rows)}},themeRoller:{start:function(q){f.obj.header().addClass(f.cl.uiControl);f.obj.label().addClass(f.cl.uiControl);f.obj.formula().addClass(f.cl.uiControlTextBox)},cell:{setHighlighted:function(t,s){var r,u=f.highlightedLast.obj,q=f.obj.scrollStyleX();if(u&&u.length&&!s){r=u.length-1;do{u[r].isHighlighted=false}while(r-->0)}if(t&&t.length>0){r=t.length-1;do{if(!t[r].isHighlighted){t[r].isHighlighted=true;if(!t[r].className.match(f.cl.uiTdHighlighted)){t[r].className+=" "+f.cl.uiTdHighlighted}}}while(r-->0)}if(s){f.highlightedLast.obj=f.highlightedLast.obj.add(t)}else{f.themeRoller.cell.clearHighlighted(u);if(t){f.highlightedLast.obj=t}}q.touch()},isHighlighted:function(){return(f.highlightedLast.obj.length?true:false)},clearHighlighted:function(r,q){if(f.themeRoller.cell.isHighlighted()){r=r||f.highlightedLast.obj;if(r&&r.length){i=r.length-1;do{if(!r[i].isHighlighted||q){r[i].className=r[i].className.replace(" "+f.cl.uiTdHighlighted,"");r[i].isHighlighted=false}}while(i-->0)}}f.highlightedLast.obj=d([])}},bar:{style:function(q){d(q).addClass(f.cl.uiBar)},setActive:function(q,r){switch(q){case"top":f.highlightedLast.barTop.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barTop=d(r).addClass(f.cl.uiBarHighlight);break;case"left":f.highlightedLast.barLeft.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barLeft=d(r).addClass(f.cl.uiBarHighlight);break}},clearActive:function(){f.highlightedLast.barLeft.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barLeft=d([]);f.highlightedLast.barTop.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barTop=d([])}},tab:{setActive:function(q){this.clearActive();f.obj.tab().addClass(f.cl.uiTabActive)},clearActive:function(){f.obj.tabContainer().find("span."+f.cl.uiTabActive).removeClass(f.cl.uiTabActive)}}},resizable:function(r,q){if(!r.data("resizable")){r.resizable(q)}},frozenAt:function(){if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0}}return f.s.frozenAt[f.i]},scrolledTo:function(){if(!f.scrolledArea[f.i]){var q=f.frozenAt();f.scrolledArea[f.i]={start:{row:j.max(q.row,1),col:j.max(q.col,1)},end:{row:j.max(q.row,1),col:j.max(q.col,1)}}}return f.scrolledArea[f.i]},busy:[],setBusy:function(q){if(q){f.busy.push(q)}else{f.busy.pop()}},isBusy:function(){return(f.busy.length>0?true:false)},draggable:function(r,q){if(!r.data("jSdraggable")){r.data("jSdraggable",true).draggable(q)}},nearest:function(r,q){return d(r).nearest(q)},resizeBar:{top:function(t,r,u,q){f.obj.barTopControls().remove();var s=d('<div class="'+f.cl.barController+'" />').width(t.width()).height(0).prependTo(t);f.controls.bar.x.controls[f.i]=f.obj.barTopControls().add(s);f.resizableCells(s,{handles:"e",start:function(w,v){f.autoFillerHide();f.setBusy(true);this.col=d(f.col(q,r))},resize:function(w,v){this.col.width(v.size.width).attr("width",v.size.width+"px").css("width",v.size.width+"px")},stop:function(w,v){f.setBusy(false);u.resizeScroll();f.followMe();f.setDirty(true)}})},left:function(u,r,x,q){f.obj.barLeftControls().remove();var v=u.offset(),s=d('<div class="'+f.cl.barController+'"></div>').prependTo(u).offset({top:v.top,left:v.left});f.controls.bar.y.controls[f.i]=f.obj.barLeftControls().add(s);var w=d('<div class="barControllerChild"></div>').height(u.height()).prependTo(s),t=u.parent().add(u).add(s);f.resizableCells(w,{handles:"s",start:function(){f.autoFillerHide();f.setBusy(true)},resize:function(z,y){t.height(y.size.height).attr("height",(y.size.height)).css("height",y.size.height+"px")},stop:function(z,y){f.setBusy(false);x.resizeScroll();f.followMe();f.setDirty(true)}})},corner:function(){}},sheetDecorateRemove:function(r,q){q=q||f.obj.tables();q=(r?q.clone():q);q.find("td."+f.cl.uiTdActive).removeClass(f.cl.uiTdActive);q.find("td."+f.cl.uiTdHighlighted).removeClass(f.cl.uiTdHighlighted);return q},sheetBarsRemove:function(q){q=d(q?q:f.obj.tables());q.find("tr."+f.cl.barTopParent).remove();q.find("td."+f.cl.barLeft).remove();return q},labelUpdate:function(r,q){if(!q){r=jSE.parseCellName(r.col,r.row);if(r){f.obj.label().text(r)}}else{f.obj.label().text(r)}},cellEdit:function(x,t,s){if(f.cellLast.td.length<1){}f.autoFillerNotGroup=true;f.evt.cellEditDone();var u=f.getTdLocation(x),q=x[0].jSCell,r;if(!q){return}f.trigger("sheetCellEdit",[q]);if(!x.is(f.cellLast.td)){f.followMe(x)}f.labelUpdate(u);if(q.formula){r="="+q.formula}else{r=q.value}var w=f.obj.formula().val(r).blur();f.cellSetActive(x,u,t,null,null,s)},cellSetActive:function(u,w,r,y,v,s){if(w.col!=n){f.cellLast.td=u;f.cellLast.row=f.rowLast=w.row;f.cellLast.col=f.colLast=w.col;if(!s){f.themeRoller.cell.setHighlighted(u);f.highlightedLast.start=w;f.highlightedLast.end=w}f.themeRoller.bar.setActive("left",u[0].barLeft);f.themeRoller.bar.setActive("top",u[0].barTop);var x,z;switch(p.cellSelectModel){case"excel":case"gdrive":x=function(){};z=function(){};break;case"oo":x=function(A){if(f.isCell(A)){f.cellEdit(d(A))}};z=function(){};break}if(r){var q={},t=f.obj.pane();q.last=w;t.onmousemove=function(C){C=C||h.event;C.target=C.target||C.srcElement;if(f.isBusy()){return false}var B=f.highlightedLast.end=f.getTdLocation(C.target),A=true;if(B.col<1||B.row<1){return false}if(y){A=false;if(w.col==B.col||w.row==B.row){A=true}}if((q.last.col!=B.col||q.last.row!=B.row)&&A){x(C.target);f.cycleCellArea(function(D){f.themeRoller.cell.setHighlighted(D.td)},w,B)}q.last=B};k.onmouseup=function(){t.onmousemove=null;t.onmousemove=null;t.onmouseup=null;k.onmouseup=null;if(v){v()}}}}},colLast:0,rowLast:0,cellLast:{td:d([]),row:0,col:0,isEdit:false},highlightedLast:{obj:d([]),start:{row:0,col:0},end:{row:0,col:0},barLeft:d([]),barTop:d([])},highlightedLastOrdered:function(){var r=this.highlightedLast,q={start:{},end:{}};q.start.row=Math.min(r.start.row,r.end.row);q.start.col=Math.min(r.start.col,r.end.col);q.end.row=Math.max(r.start.row,r.end.row);q.end.col=Math.max(r.start.col,r.end.col);return q},cellStyleToggle:function(w,x){f.setDirty(true);var u=f.highlighted(),s,q,v=u.length-1,y=f.obj.cellsEdited(),r=f.controls.cellsEdited[f.i],t;if(v>=0){t=d(u[0]).hasClass(w);do{s=u[v];q=d(s);if(x){q.removeClass(x)}else{if(t){q.removeClass(w)}else{q.addClass(w)}if(!s.jSCell.edited){s.jSCell.edited=true;r=y.add(s.jSCell)}}}while(v--);return true}return false},fontReSize:function(w){var s=0;switch(w){case"up":s=1;break;case"down":s=-1;break}var u=f.highlighted(),t,q,v=u.length-1,y,x=f.obj.cellsEdited(),r=f.controls.cellsEdited[f.i];if(v>=0){do{t=u[v];q=d(t);y=(q.css("font-size")+"").replace("px","")*1;q.css("font-size",((y||10)+s)+"px");if(!t.jSCell.edited){t.jSCell.edited=true;r=x.add(t.jSCell)}}while(v--);return true}return false},callStack:0,updateCellValue:function(x,t,v){var s,y,w,u;if(!this.type||!this.type=="cell"){if(!(s=f.spreadsheets[x])){return p.error({error:f.msg.notFoundSheet})}if(!(y=s[t])){return p.error({error:f.msg.notFoundRow})}if(!(w=y[v])){return p.error({error:f.msg.notFoundColumn})}}else{w=this;x=this.sheet;t=this.row;v=this.col}w.oldValue=w.value;if(w.result){delete w.result}switch(w.state[w.state.length-1]){case"updating":return p.error({error:f.msg.loopDetected});case"updatingDependencies":return(w.valueOverride!=n?w.valueOverride:w.value)}if(w.defer){return this.updateCellValue.apply(w.defer)}w.state.push("updating");w.html=[];w.fnCount=0;w.result=null;if(w.calcLast!=f.calcLast||w.calcDependenciesLast!=f.calcDependenciesLast){w.valueOverride=null;w.calcLast=f.calcLast;w.calcDependenciesLast=f.calcDependenciesLast;w.needsUpdated=true;w.calcCount++;if(w.formula){try{if(w.formula.charAt(0)=="="){w.formula=w.formula.substring(1)}var q;if(f.callStack){if(!w.formulaParser){w.formulaParser=(new f.formulaParser)}q=w.formulaParser}else{q=f.FormulaParser}f.callStack++;q.lexer.obj=w;q.lexer.handler=f.cellHandler;w.result=q.parse(w.formula)}catch(r){w.result=r.toString();f.alertFormulaError(w.value)}f.callStack--;f.filterValue.apply(w)}else{if(w.value!=n&&w.value.charAt){u=f.s.cellStartingHandlers[w.value.charAt(0)];if(u){u.apply(w,[w.value])}else{u=f.s.cellEndHandlers[w.value.charAt(w.value.length-1)];if(u){u.apply(w,[w.value])}}}f.filterValue.apply(w)}}w.needsUpdated=false;w.state.pop();return(w.valueOverride!=n?w.valueOverride:w.value)},updateCellDependencies:function(){if((this.state||(this.state=[])).length){return}this.state.push("updatingDependencies");var t=this.dependencies;this.dependencies={};for(var r in t){var q=t[r],s=f.getTdLocation(q.td);q.calcDependenciesLast=0;f.updateCellValue.apply(q);if(s.row>0&&s.col>0){f.updateCellDependencies.apply(q)}}this.state.pop()},filterValue:function(){var q=(this.html&&this.html.length?this.html.join(""):"");if(this.result!=n){this.value=this.result;this.td.html(q?this.html:p.encode(this.value))}else{if(q){this.td.html(this.html)}else{this.td.html(p.encode(this.value))}}},cellHandler:{variable:function(){if(arguments.length){var s=arguments[0],q=arguments[1],t=f.s.formulaVariables,r;switch(s.toLowerCase()){case"true":this.html.push("TRUE");return true;case"false":this.html.push("FALSE");return false}if(r=t[s]&&!q){return r}else{if(r&&q){return r[q]}else{return""}}}},time:function(r,q){return times.fromString(r,q)},concatenate:function(){var q=f.getTdLocation(this.td);return jFN.CONCATENATE.apply(this,arguments).value},cellValue:function(s){var r=jSE.parseLocation(s),q;q=f.cellHandler.createDependency.apply(this,[this.sheet,r]);f.updateCellValue.apply(q);return(q.valueOverride!=n?q.valueOverride:q.value)},createDependency:function(r,u){var s,t,q;if(!(s=f.spreadsheets[r])){return}if(!(t=s[u.row])){return}if(!(q=t[u.col])){return}if(!q.dependencies){q.dependencies={}}q.dependencies[r+"_"+u.row+"_"+u.col]=this;return q},cellRangeValue:function(q,r){q=jSE.parseLocation(q);r=jSE.parseLocation(r);var y=[],t=j.max(q.row,r.row),x=j.min(q.row,r.row),s=j.max(q.col,r.col),u=s,v=j.min(q.col,r.col),w;if(t>=x||s>=v){do{s=u;do{w=f.spreadsheets[this.sheet][t][s];f.cellHandler.createDependency.apply(this,[this.sheet,{row:t,col:s}]);y.unshift(f.updateCellValue.apply(w))}while(s-->v)}while(t-->x);return y}return y},fixedCellValue:function(q){q=q.replace(/\$/g,"");return f.cellHandler.cellValue.apply(this,[q])},fixedCellRangeValue:function(r,q){r=r.replace(/\$/g,"");q=q.replace(/\$/g,"");return f.cellHandler.cellRangeValue.apply(this,[r,q])},remoteCellValue:function(q,s){var r=jSE.parseLocation(s);q=jSE.parseSheetLocation(q);f.cellHandler.createDependency.apply(this,[q,r]);return f.updateCellValue(q,r.row,r.col)},remoteCellRangeValue:function(u,v,r){u=jSE.parseSheetLocation(u);v=jSE.parseLocation(v);r=jSE.parseLocation(r);var q=[];for(var t=v.row;t<=r.row;t++){for(var s=v.col;s<=r.col;s++){q.push(f.updateCellValue(u,t,s))}}return[q]},callFunction:function(v,s){v=v.toUpperCase();s=s||[];if(d.sheet.fn[v]){this.fnCount++;var r=[],u=[],t=s.length;if(t){do{if(s[t]!=n){if(s[t].value||s[t].html){r.unshift(s[t].value);u.unshift(s[t].html)}else{r.unshift(s[t]);u.unshift(s[t])}}}while(t--)}var q=d.sheet.fn[v].apply(this,r);if(q!=null){if(q.html!=n){this.html.push(q.html)}else{this.html.push(null)}if(q.value!=n){return q.value}}return q}else{return p.error({error:"Function "+v+" Not Found"})}}},cellLookupHandlers:{fixedCellValue:function(q){return[f.sheet,jSE.parseLocation(q),jSE.parseLocation(q)]},fixedCellRangeValue:function(r,s,q){return[jSE.parseSheetLocation(r),jSE.parseLocation(s),jSE.parseLocation(q)]},cellValue:function(q){},cellRangeValue:function(r,s,q){return[f.sheet,jSE.parseLocation(s),jSE.parseLocation(q)]},remoteCellValue:function(q,r){return[f.sheet,jSE.parseLocation(r),jSE.parseLocation(r)]},remoteCellRangeValue:function(r,s,q){return[jSE.parseSheetLocation(r),jSE.parseLocation(s),jSE.parseLocation(q)]},callFunction:function(){if(arguments[0]=="VLOOKUP"||arguments[0]=="HLOOKUP"&&arguments[1]){return arguments[1].reverse()[1]}}},cellLookup:function(){var q=(new f.formulaParser);q.lexer.obj=this.obj;q.lexer.handler=d.extend(q.lexer.handler,f.cellLookupHandlers);var s=q.parse(this.obj.formula),t=[];for(var u=s[1].row;u<=s[2].row;u++){for(var r=s[1].col;r<=s[2].col;r++){t.push({sheet:s[0],row:u,col:r})}}return t},alertFormulaError:function(q){alert("cell:"+row+" ;"+col+'\nvalue: "'+cell.formula+'"\nerror: \n'+e)},calcLast:0,calcDependenciesLast:0,calc:function(q){q=(q?q:f.i);if(f.readOnly[q]||f.isChanged()===false){return}f.log("Calculation Started");f.calcLast=new Date();jSE.calc(q,f.spreadsheetsToArray()[q],f.updateCellValue);f.trigger("sheetCalculation",[{which:"speadsheet"}]);f.setChanged(false);f.log("Calculation Ended")},calcDependencies:function(r,q){r=r||new Date();f.calcDependenciesLast=r;if(!q){f.cellUndoable.add.apply(this,[r])}f.trigger("sheetPreCalculation",[{which:"cell",cell:this}]);f.setDirty(true);f.setChanged(true);f.updateCellValue.apply(this);f.updateCellDependencies.apply(this);f.trigger("sheetCalculation",[{which:"cell",cell:this}]);if(!q){f.cellUndoable.add.apply(this,[r,true])}},addSheet:function(q){if(!q){q=prompt(f.msg.newSheet);q=q.toLowerCase().split("x");q={cols:d.trim(q[0])*1,rows:d.trim(q[1])*1}}if(q){f.evt.cellEditAbandon();f.setDirty(true);var r=f.controlFactory.sheetUI(f.obj.ui()[0],d.sheet.makeTable.fromSize(q),f.sheetCount);f.setActiveSheet(f.sheetCount-1);f.sheetSyncSize();f.obj.pane().resizeScroll();f.trigger("sheetAdd",[f.i])}},deleteSheet:function(q){var r=q||f.i;f.obj.barHelper().remove();f.obj.enclosure().remove();f.obj.tabContainer().children().eq(f.i).remove();f.spreadsheets.splice(r,1);f.controls.autoFiller.splice(r,1);f.controls.bar.helper.splice(r,1);f.controls.bar.corner.splice(r,1);f.controls.bar.x.controls.splice(r,1);f.controls.bar.x.handleFreeze.splice(r,1);f.controls.bar.x.controls.splice(r,1);f.controls.bar.x.menu.splice(r,1);if(f.controls.bar.x.menuParent&&f.controls.bar.x.menuParent[r]){f.controls.bar.x.menuParent.splice(r,1)}f.controls.bar.x.parent.splice(r,1);f.controls.bar.x.scroll.splice(r,1);f.controls.bar.x.td.splice(r,1);f.controls.bar.y.controls.splice(r,1);f.controls.bar.y.handleFreeze.splice(r,1);f.controls.bar.y.controls.splice(r,1);f.controls.bar.y.menu.splice(r,1);if(f.controls.bar.y.menuParent&&f.controls.bar.y.menuParent[r]){f.controls.bar.y.menuParent.splice(r,1)}f.controls.bar.y.parent.splice(r,1);f.controls.bar.y.scroll.splice(r,1);f.controls.bar.y.td.splice(r,1);f.controls.barMenuLeft.splice(r,1);f.controls.barMenuTop.splice(r,1);f.controls.barLeft.splice(r,1);f.controls.barTop.splice(r,1);f.controls.barTopParent.splice(r,1);f.controls.chart.splice(r,1);f.controls.tdMenu.splice(r,1);f.controls.enclosure.splice(r,1);f.controls.fullScreen.splice(r,1);f.controls.inPlaceEdit.splice(r,1);f.controls.menuLeft.splice(r,1);f.controls.menuRight.splice(r,1);f.controls.pane.splice(r,1);f.controls.scroll.splice(r,1);f.controls.tables.splice(r,1);f.controls.table.splice(r,1);f.controls.tab.splice(r,1);f.controls.toggleHide.x.splice(r,1);f.controls.toggleHide.y.splice(r,1);f.readOnly.splice(r,1);f.i=0;f.sheetCount--;f.sheetCount=j.max(f.sheetCount,0);if(f.sheetCount==0){f.addSheet({rows:25,cols:10})}f.setActiveSheet(f.i);f.setDirty(true);f.setChanged(true);f.trigger("sheetDelete",[r])},deleteRow:function(r,q){r=r||f.rowLast;f.getTd(f.i,r,1).parent().remove();f.controls.bar.y.td[f.i].splice(r,1);f.spreadsheets[f.i].splice(r,1);f.refreshRowLabels(r);f.setChanged(true);f.offsetFormulas({row:r,col:0},{row:-1,col:0});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().resizeScroll();f.trigger("sheetDeleteRow",r)},deleteColumn:function(t,q){t=t||f.colLast;if(t<1){return}f.obj.barHelper().remove();var w=f.obj.table(),s=f.col(w[0],t),v=f.obj.barTop(t).remove(),u=s.tds,r=u.length-1;do{d(u[r]).remove()}while(r--);f.obj.barTop(t).remove();f.controls.bar.x.td[f.i].splice(t,1);r=f.spreadsheets[f.i].length-1;do{f.spreadsheets[f.i][r].splice(t,1)}while(r-->1);d(s).remove();f.refreshColumnLabels(t);f.setChanged(true);f.offsetFormulas({row:0,col:t},{row:0,col:-1});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().resizeScroll();f.trigger("sheetDeleteColumn",t)},sheetTab:function(r){var q="";if(r){q=f.obj.table().attr("title");q=(q?q:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1))}else{if(f.isSheetEditable()&&p.editableNames){var s=prompt(f.msg.newSheetTitle,f.sheetTab(true));if(!s){q=f.obj.table().attr("title");s=(q?q:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1))}else{f.setDirty(true);f.obj.table().attr("title",s);f.obj.tab().html(s);q=s}}}return d("<div />").text(q).html()},followMe:function(v,t){v=v||f.obj.tdActive();if(!v.length){return}var H=f.obj.pane(),B={top:0,bottom:H.clientHeight,left:0,right:H.clientWidth},I=true,K=0,A=0,z=0,J=5,G=v.width(),E=v.height(),F={top:v[0].offsetTop,bottom:v[0].offsetTop+E,left:v[0].offsetLeft,right:v[0].offsetLeft+G},u=v.parent(),D,s=0,M=0,q={up:true,down:true,left:true,right:true},w=f.scrolledTo();if(E>H.clientHeight||G>H.clientWidth){return}f.setBusy(true);while(I==true&&K<J){var r=f.getTd(f.i,w.end.row+z,w.end.col+A),C=v[0].clientHeight==0,L=u[0].clientHeight==0;I=false;D={up:L,down:F.bottom-s>B.bottom,left:C,right:F.right-M>B.right};if(D.left){if(t){q.left=false}else{A--;I=true;f.evt.scroll.scrollTo({axis:"x",value:w.end.col+A})}}else{if(D.right){if(t){q.right=false}else{A++;I=true}}}if(D.up){if(t){q.up=false}else{z--;I=true;f.evt.scroll.scrollTo({axis:"y",value:w.end.row+z})}}else{if(D.down){if(t){q.down=false}else{z++;I=true}}}if(t){f.setBusy(false);return q}s+=r.height();M+=r.width();K++}if(A>0){f.evt.scroll.scrollTo({axis:"x",value:(w.end.col+1)+A});f.evt.scroll.stop()}if(z>0){f.evt.scroll.scrollTo({axis:"y",value:(w.end.row+1)+z});f.evt.scroll.stop()}setTimeout(function(){f.setBusy(false)},100);f.autoFillerGoToTd(v,E,G)},autoFillerGoToTd:function(t,r,s){if(!p.autoFiller){return}t=t||f.obj.tdActive();r=r||t.height();s=s||t.width();if(t[0]&&t[0].type=="cell"&&t.is(":visible")){var q=t.position();f.obj.autoFiller().show().css("top",((q.top+(r||t.height())-3)+"px")).css("left",((q.left+(s||t.width())-3)+"px"))}else{f.autoFillerHide()}},autoFillerHide:function(){if(!p.autoFiller){return}f.obj.autoFiller().hide()},setActiveSheet:function(q){q=q||0;if(f.cellLast.row>0||f.cellLast.col>0){f.evt.cellEditDone();f.obj.formula().val("")}f.obj.enclosures().hide();f.i=q;f.obj.enclosure().show();f.themeRoller.tab.setActive();f.readOnly[q]=f.obj.table().hasClass("readonly");f.obj.pane().resizeScroll()},openSheet:function(s){if(f.isDirty?confirm(f.msg.openSheet):true){f.setBusy(true);var u=f.controlFactory.header(),t=f.controlFactory.ui(),q=f.controlFactory.tabContainer(),r=s.length-1;p.parent.append(u).append(t).append(q);do{f.controlFactory.sheetUI(t,s[r],r);f.calc(r);f.trigger("sheetOpened",[r])}while(r--);f.sheetSyncSize();f.setActiveSheet(0);f.setDirty(false);f.setBusy(false);f.trigger("sheetAllOpened");return true}else{return false}},newSheet:function(){var q=prompt(f.msg.newSheet);if(q){f.openSheet(d.sheet.makeTable.fromSize(q))}},importRow:function(r){f.controlFactory.addRow();var q="";f.obj.table().find("tr:last td").each(function(s){d(this).removeData("formula");try{if((r[s]+"").charAt(0)=="="){d(this).data("formula",r[s])}else{d(this).html(r[s])}}catch(t){q+=t+";\n"}});if(q){alert(q)}f.calc()},importColumn:function(q){f.controlFactory.addColumn();var r="";f.obj.table().find("tr").each(function(s){var u=d(this).find("td:last");try{if((q[s]+"").charAt(0)=="="){u.data("formula",q[s])}else{u.html(q[s])}}catch(t){r+=t+";\n"}});if(r){alert(r)}f.calc()},sheetSyncSize:function(){var r=p.height;if(!r){r=400}else{if(r<200){r=200}}p.parent.height(r).width(p.width);var q=p.width;r-=f.obj.header().outerHeight();r-=f.obj.tabContainer().outerHeight()+f.s.boxModelCorrection;f.obj.panes().height(r-window.scrollBarSize.height-p.boxModelCorrection).width(q-window.scrollBarSize.width);f.obj.enclosures().height(r).width(q);f.obj.scrolls().height(r).width(q);f.obj.ui().height(r).width(q)},cellChangeStyle:function(s,t){f.setDirty(this);var q=f.highlighted(true),r=q.length-1;if(r>=0){do{f.cellUndoable.add(q[r]);q[r].td.css(s,t);f.cellUndoable.add(q[r],true)}while(r--);return true}return false},cellFind:function(r){if(!r){r=prompt(f.msg.cellFind)}var q=f.obj.table().children("tbody").children("tr");if(r){var s=q.children('td:contains("'+r+'")');if(s.length<1){s=q.children('td:contains("'+r.toLowerCase()+'")')}if(s.length<1){s=q.children('td:contains("'+r.toUpperCase()+'")')}s=s.eq(0);if(s.length>0){f.cellEdit(s)}else{alert(f.msg.cellNoFind)}}},cellSetActiveBar:function(z,t,u){var D=f.sheetSize(),w=j.min(t,u),B=j.max(t,u),r={},A={},q=function(E){switch(p.cellSelectModel){case"oo":this.row=(E?r.row:A.row);this.col=(E?r.col:A.col);this.td=f.getTd(f.i,this.row,this.col);if(!this.td.is(f.cellLast.td)){f.cellEdit(this.td,null,true)}break;default:this.row=(E?A.row:r.row);this.col=(E?A.col:r.col);this.td=f.getTd(f.i,this.row,this.col);if(!this.td.is(f.cellLast.td[0])){f.cellEdit(this.td,null,true)}break}},v=d([]),x=f.scrolledTo(),y=f.obj.table(),s,C;switch(z){case"top":r.row=x.end.row;r.col=w;A.row=x.end.row;A.col=B;f.highlightedLast.start.row=1;f.highlightedLast.start.col=w;f.highlightedLast.end.row=D.rows;f.highlightedLast.end.col=B;s=B;do{v=v.add(f.col(y[0],s))}while(s-->w);break;case"left":r.row=w;r.col=x.end.col;A.row=B;A.col=x.end.col;f.highlightedLast.start.row=w;f.highlightedLast.start.col=1;f.highlightedLast.end.row=B;f.highlightedLast.end.col=D.cols;C=B;do{v=v.add(f.getTd(f.i,C,1)[0].parentNode)}while(C-->w);break;case"corner":r.row=1;r.col=1;A.col=D.cols;A.row=D.rows;v=v.add(y);break}q(t>u);f.themeRoller.cell.setHighlighted(v)},getTdRange:function(t,z,x,y){f.cellLast.isEdit=true;var r=function(v){if(v.first.col>v.last.col||v.first.row>v.last.row){return{first:jSE.parseCellName(v.last.col,v.last.row),last:jSE.parseCellName(v.first.col,v.first.row)}}else{return{first:jSE.parseCellName(v.first.col,v.first.row),last:jSE.parseCellName(v.last.col,v.last.row)}}},w=function(D){var v=r(D),C=z+"";C=(C.match(/=/)?C:"="+C);if(x||C.charAt(C.length-1)!="("){C=C+(x?x:"")+"("}var E,B="";if(v.first!=v.last){E=v.first+":"+v.last}else{E=v.first}if(C.charAt(C.length-1)=="("){B=")"}return C+E+B},q="",s,u,A;if(t){s={first:f.getTdLocation([t.target])};u=f.obj.table().mousemove(function(v){s.last=f.getTdLocation([v.target]);q=w(s);if(!y){f.obj.formula().val(q);f.obj.inPlaceEdit().val(q)}});c.one("mouseup",function(){u.unbind("mousemove");return q})}else{A=f.highlighted().not(f.obj.tdActive());if(A.length){var s={first:f.getTdLocation(A.first()),last:f.getTdLocation(A.last())};q=w(s);if(!y){f.obj.formula().val(q);f.obj.inPlaceEdit().val(q)}return q}else{return""}}},getTd:function(u,w,r){var s=f.obj.tables()[u],q,t,v;if(!s||!(q=s.children[1])||!(t=q.children[w])||!(v=t.children[r])){return d("<td />")}return d(v)},getTdLocation:function(r){var q={col:0,row:0};r=r||"";if(!r&&!r[0]){return q}r=r[0]||r;if(r.cellIndex==n||r.parentNode==n||r.parentNode.rowIndex==n){return q}return{col:parseInt(r.cellIndex),row:parseInt(r.parentNode.rowIndex)}},getTdFromXY:function(t,s,q){var v=f.obj.pane(),r=v.offset();s+=r.top;t+=r.left;if((s>=r.top&&s<=r.top+v.height())&&(t>=r.left&&t<=r.left+v.width())){var u=d.nearest({x:t,y:s},f.obj.table().children("tbody").children("tr").children("td"));if(u.type=="cell"){return u}if(q&&u.type=="bar"){return u}return false}return false},getBarIndex:{left:function(q){q=q||{};if(!q.parentNode||isNaN(q.parentNode.rowIndex)){return -1}else{return q.parentNode.rowIndex}},top:function(q){q=q||{};if(isNaN(q.cellIndex)){return -1}else{return q.cellIndex}},corner:function(){return 0}},time:{now:new Date(),last:new Date(),diff:function(){return j.abs(j.ceil(this.last.getTime()-this.now.getTime())/1000).toFixed(5)},set:function(){this.last=this.now;this.now=new Date()},get:function(){return this.now.getHours()+":"+this.now.getMinutes()+":"+this.now.getSeconds()}},log:function(q){f.time.set();console.log(f.time.get()+", "+f.time.diff()+"; "+q)},changed:[],isChanged:function(){return f.changed[f.i]},setChanged:function(q){f.changed[f.i]=q},isDirty:false,setDirty:function(q){f.dirty=q},appendToFormula:function(q){var s=f.obj.formula(),r=s.val();if(r.charAt(0)!="="){r="="+r}s.val(r+q)},cellUndoable:{stacks:[],undoOrRedo:function(r){if(!this.stacks[f.i]){return}f.autoFillerHide();var q=this.stack(),s;if(r){q.moveBackward()}else{q.moveForward()}s=q.getCells();for(var t in s){var v=s[t].td,u=f.getTdLocation(v);f.spreadsheets[f.i][u.row][u.col]=s[t];v.data("formula",s[t].formula).attr("style",s[t].style).addClass(s[t].cl);f.cellLast.td=d([]);f.calcDependencies.apply(s[t],null,true)}},stack:function(){if(!this.stacks[f.i]){this.stacks[f.i]={i:0,max:20,lasts:[],lastsCells:[],getCells:function(r){var q=(r?d.inArray(r,this.lasts):this.i);if(q<0){this.i=this.lasts.length;this.lasts.push(r);q=this.lasts.length-1;this.lastsCells[q]=[]}return this.lastsCells[q]},cleanAhead:function(){this.lasts.splice(this.i+1,this.lasts.length-this.i);this.lastsCells.splice(this.i+1,this.lasts.length-this.i)},cleanBehind:function(){while(this.lasts.length>this.max){this.lasts.shift();this.lastsCells.shift()}},moveForward:function(){this.i+=1;this.i=j.min(this.i,this.lasts.length-1)},moveBackward:function(){this.i-=1;this.i=j.max(this.i,0)}}}return this.stacks[f.i]},add:function(w,t,y,r,q){var v=f.cellUndoable.stack(),x=v.getCells(w.valueOf()+(q?1:0));v.cleanAhead();if(y>0&r>0){var u={};for(var s in cell){u[s]=this[s]}u.style=this.td.attr("style");u.cl=(this.td.attr("class")||"").replace(f.cl.uiTdActive,"").replace(f.cl.uiTdHighlighted,"");u.sheet=this.sheet}x.push(u);v.cleanBehind()}},cols:function(q){q=q||f.obj.table()[0];if(!q){return[]}if(!q.colgroup){return[]}if(!q.colgroup.children){return[]}return q.colgroup.children},tables:function(q){q=q||f.obj.tables();q=q.clone();q.find("."+f.cl.barTopParent).remove();q.find("."+f.cl.barLeft).remove();q.children("colgroup").children("col:first").remove();q=f.sheetDecorateRemove(false,q);return q},col:function(s,q){s=s||f.obj.table()[0];var r=f.cols(s);if(q===n){q=r.length-1}return r[q]},rowTds:function(s,r){s=s||f.obj.table();var q=f.rows(s);if(r==n){r=q.length-1}if(!q[r]){return{}}if(!q[r].children){return{}}return q[r].children},rows:function(q){q=q||f.obj.table()[0];if(!q){return{}}if(!q.tbody){return{}}if(!q.tbody.children){return{}}return q.tbody.children},highlighted:function(r){var t=f.highlightedLast.obj||d([]),u=[],q,s;if(!(q=t)||!t.length||!(q=q[0])||!q.tagName){return u}switch(q.tagName){case"TD":s=t.length-1;do{u.unshift(r?t[s].jSCell:t[s])}while(s-->0);case"TR":s=t.length-1;do{if(t[s].tds){u=u.concat(r?t[s].jSCells:t[s].tds)}}while(s-->0);break;case"COL":t=t.filter("col");s=t.length-1;do{if(t[s].tds){u=u.concat(r?t[s].jSCells:t[s].tds)}}while(s-->0);break;case"TABLE":u=(r?q.jSCells:q.tds);break}return r?u:d(u)},sheetSize:function(s){s=s||f.obj.table()[0];var q=f.rowTds(s),r=f.getTdLocation(q[q.length-1]);return{cols:r.col,rows:r.row}},toggleState:function(q){if(p.allowToggleState){var r=q||f.tables().detach();if(p.editable){f.evt.cellEditAbandon();f.trigger("sheetSave",[r])}f.setDirty(false);f.setChanged(true);p.editable=!p.editable;f.kill();p.parent.html(r).sheet(p);p=null}},setCellRef:function(r){var t=f.obj.tdActive(),s=f.getTdLocation(t),q=(r?r:prompt(f.msg.setCellRef));if(q){f.s.formulaVariables[q]=f.updateCellValue(f.i,s.row,s.col)}}};f.setBusy(true);p.parent.data("sheetInstance",f);if(!window.console){window.console={log:function(){}}}if(!window.scrollBarSize){window.scrollBarSize=d.sheet.getScrollBarSize()}var h=window,a=d(h),k=document,c=d(k),b=d("body"),m=function(){},n=undefined,j=Math;f.formulaLexer=function(){};f.formulaLexer.prototype=formula.lexer;f.formulaParser=function(){this.lexer=new f.formulaLexer();this.yy={}};f.formulaParser.prototype=formula;f.FormulaParser=new f.formulaParser;p.origHtml=p.parent.children().detach();p.parent.addClass(f.cl.parent);p.parent.bind("sheetSwitch",function(s,r,q){f.switchSheet(q)}).bind("sheetRename",function(s,r,q){f.renameSheet(q)});p.width=(p.width?p.width:p.parent.width());p.height=(p.height?p.height:p.parent.height());if(!p.log){f.log=m}if(!d.nearest){f.nearest=m}f.resizableCells=f.resizableSheet=f.resizable;if(!d.ui){f.resizable=f.resizableCells=f.resizableSheet=f.draggable=m}else{if(!p.resizableCells){f.resizableCells=m}if(!p.resizableSheet){f.resizableSheet=m}}if(!d.support.boxModel){p.boxModelCorrection=0}if(!p.barMenus){f.controlFactory.barMenuTop=f.controlFactory.barMenuLeft=m}if(!p.freezableCells){f.controlFactory.barHandleFreeze.top=f.controlFactory.barHandleFreeze.left=m}if(p.calcOff){f.calc=m}if(!window.Raphael){jSE.chart=m}a.resize(function(){if(f&&!f.isBusy()){p.width=p.parent.width();p.height=p.parent.height();f.sheetSyncSize()}});if(d.sheet.fn){d.sheet.fn=d.extend(d.sheet.fn,p.formulaFunctions);if(d.sheet.advancedfn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.advancedfn)}if(d.sheet.financefn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.financefn)}}if(!p.alertFormulaErrors){f.alertFormulaError=m}p.title=p.title||p.parent.attr("title")||"";f.s=p;p.parent.addClass(f.cl.uiParent);if(p.origHtml.length){f.openSheet(p.origHtml)}f.setBusy(false);return f},makeTable:{fromSize:function(d){var h=document;d=d||{rows:25,cols:10};var f=h.createElement("table"),b=h.createElement("tbody"),g;f.appendChild(b);for(var c=d.rows;c>=1;c--){g=h.createElement("tr");g.setAttribute("style","height:15px;");for(var a=d.cols;a>=1;a--){g.appendChild(h.createElement("td"))}b.appendChild(g)}return f}},killAll:function(){if(jQuery.sheet){if(jQuery.sheet.instance){jQuery.sheet.instance.each(function(){if(this.kill){this.kill()}});jQuery.sheet.instance=$([])}}},scrollLocker:function(a){jQuery.sheet.instance[a].obj.scrolls().each(function(b){var c=this;$(this).bind("scroll",function(){jQuery.sheet.instance.each(function(d){if(d!=a){this.controls.scroll[b].scrollLeft(c.scrollLeft).scrollTop(c.scrollTop)}})})})},switchSheetLocker:function(a){jQuery.sheet.instance.each(function(){this.s.parent.bind("switch",function(d,c,b){jQuery.sheet.instance.each(function(){this.setActiveSheet(b)})})})},I:function(){var a=0;if(this.instance){a=(this.instance.length===0?0:this.instance.length-1)}else{this.instance=[]}return a},getScrollBarSize:function(){var d=$("<p></p>").css({width:"100%",height:"100%"}),j=$("<div></div>").css({position:"absolute",width:"100px",height:"100px",top:"0",left:"0",visibility:"hidden",overflow:"hidden"}).append(d);jQuery(document.body).append(j);var c=d.width(),g=d.height();j.css("overflow","scroll");var a=d.width(),f=d.height();if(c==a&&j[0].clientWidth){a=j[0].clientWidth}if(g==f&&j[0].clientHeight){f=j[0].clientHeight}j.detach();var b=c-a,k=g-f;return{width:b||15,height:k||15}},debugPositionBox:function(a,g,c,b,f){b=b||"#"+Math.floor(Math.random()*16777215).toString(16);if(c){var d=jQuery([]);d=d.add(this.debugPositionBox(c.left,c.top,null,b,"top-left"));d=d.add(this.debugPositionBox(c.right,c.top,null,b,"top-right"));d=d.add(this.debugPositionBox(c.left,c.bottom,null,b,"bottom-left"));d=d.add(this.debugPositionBox(c.right,c.bottom,null,b,"bottom-right"));return d}return jQuery('<div style="width: 10px; height: 10px; position: absolute;"></div>').css("top",(g-5)+"px").css("left",(a+5)+"px").css("background-color",b).click(function(){console.log(f||"none")}).appendTo("body")}};var jSE=jQuery.sheet.engine={calc:function(c,a,d){a=a||[];var f=a.length-1,b;if(f>0){do{if(f>0&&a[f]){b=a[f].length-1;if(b>0){do{d(c,f,b)}while(b--)}}}while(f--)}},parseLocation:function(b){for(var a=0;a<b.length;a++){if(b.charCodeAt(a)<=57){break}}return{row:parseInt(b.substring(a)),col:jSE.columnLabelIndex(b.substring(0,a))}},parseSheetLocation:function(a){return((a+"").replace("SHEET","")*1)-1},parseCellName:function(a,b){return jSE.columnLabelString(a)+(b||"")},columnLabels:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",columnLabelIndex:function(c){var a=0,c=c.toUpperCase();for(var b=0;b<c.length;b++){var d=this.columnLabels.indexOf(c[b]);a=(a*26)+d}return(a>=0?a:0)+1},columnIndexes:[],columnLabelString:function(d){if(!this.columnIndexes.length){var g="",f,c,b,a;f=c=b=-1;for(a=1;a<16385;++a){g="";++b;if(b==26){b=0;++c;if(c==26){c=0;++f}}if(f>=0){g+=this.columnLabels[f]}if(c>=0){g+=this.columnLabels[c]}if(b>=0){g+=this.columnLabels[b]}this.columnIndexes[a]=g}}return this.columnIndexes[d]||""},regEx:{n:/[\$,\s]/g,cell:/\$?([a-zA-Z]+|[#]REF[!])\$?([0-9]+|[#]REF[!])/gi,range:/\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCell:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCellRange:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,sheet:/SHEET/i,amp:/&/g,gt:/</g,lt:/>/g,nbsp:/&nbsp;/g},chart:function(d){var c=this.jS,a=this;function b(f,g){if(!f){if(g){f=0}else{f=""}}else{if(g){f=arrHelpers.toNumbers(f)}else{f=arrHelpers.flatten(f)}}return f}d=jQuery.extend({x:{legend:"",data:[0]},y:{legend:"",data:[0]},title:"",data:[0],legend:"",td:this.td,chart:jQuery(document.createElement("div")).addClass(c.cl.chart).mousedown(function(){d.td.mousedown()}),gR:{}},d);c.controls.chart[c.i]=c.obj.chart().add(d.chart);d.data=b(d.data,true);d.x.data=b(d.x.data,true);d.y.data=b(d.y.data,true);d.legend=b(d.legend);d.x.legend=b(d.x.legend);d.y.legend=b(d.y.legend);d.legend=(d.legend?d.legend:d.data);c.s.parent.one("sheetCalculation",function(){var g=d.chart.width(),f=d.chart.height(),h=Raphael(d.chart[0]);if(d.title){h.text(g/2,10,d.title).attr({"font-size":20})}switch(d.type){case"bar":d.gR=h.barchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this)},function(){this.flag.animate({opacity:0},300,function(){this.remove()})});break;case"hbar":d.gR=h.hbarchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this)},function(){this.flag.animate({opacity:0},300,function(){this.remove()})});break;case"line":d.gR=h.linechart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,{nostroke:false,axis:"0 0 1 1",symbol:"circle",smooth:true}).hoverColumn(function(){this.tags=h.set();if(this.symbols.length){for(var j=0,k=this.y.length;j<k;j++){this.tags.push(h.tag(this.x,this.y[j],this.values[j],160,10).insertBefore(this).attr([{fill:"#fff"},{fill:this.symbols[j].attr("fill")}]))}}},function(){this.tags&&this.tags.remove()});break;case"pie":d.gR=h.piechart(g/2,f/2,(g<f?g:f)/2,d.data,{legend:d.legend}).hover(function(){this.sector.stop();this.sector.scale(1.1,1.1,this.cx,this.cy);if(this.label){this.label[0].stop();this.label[0].attr({r:7.5});this.label[1].attr({"font-weight":800})}},function(){this.sector.animate({transform:"s1 1 "+this.cx+" "+this.cy},500,"bounce");if(this.label){this.label[0].animate({r:5},500,"bounce");this.label[1].attr({"font-weight":400})}});break;case"dot":d.gR=h.dotchart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,d.data,{symbol:"o",max:10,heat:true,axis:"0 0 1 1",axisxstep:d.x.data.length-1,axisystep:d.y.data.length-1,axisxlabels:(d.x.legend?d.x.legend:d.x.data),axisylabels:(d.y.legend?d.y.legend:d.y.data),axisxtype:" ",axisytype:" "}).hover(function(){this.marker=this.marker||h.tag(this.x,this.y,this.value,0,this.r+2).insertBefore(this);this.marker.show()},function(){this.marker&&this.marker.hide()});break}d.gR.mousedown(function(){d.td.mousedown().mouseup()});d.chart.mousemove(function(){d.td.mousemove();return false})});return d.chart}};var jFN=jQuery.sheet.fn={ISNUMBER:function(a){if(!isNaN(a)){return{value:true,html:"TRUE"}}return{value:false,html:"FALSE"}},N:function(a){if(a==null){return 0}if(a instanceof Date){return a.getTime()}if(typeof(a)=="object"){a=a.toString()}if(typeof(a)=="string"){a=parseFloat(a.replace(jSE.regEx.n,""))}if(isNaN(a)){return 0}if(typeof(a)=="number"){return a}if(a==true){return 1}return 0},VERSION:function(){return this.jS.version},ABS:function(a){return Math.abs(jFN.N(a))},CEILING:function(b,a){a=a||1;return(parseInt(b/a)*a)+a},EVEN:function(a){a=Math.round(a);var b=(a%2==0);if(!b){if(a>0){a++}else{a--}}return a},EXP:function(a){return Math.exp(a)},FLOOR:function(b,a){a=a||1;if((b<0&&a>0)||(b>0&&a<0)){return{value:0,html:"#NUM"}}if(b>=0){return Math.floor(b/a)*a}else{return Math.ceil(b/a)*a}},INT:function(a){return Math.floor(jFN.N(a))},LN:function(a){return Math.log(a)},LOG:function(a,b){b=b||10;return Math.log(a)/Math.log(b)},LOG10:function(a){return jFN.LOG(a)},MOD:function(a,c){var b=a%c;if(c<0){b*=-1}return b},ODD:function(a){var c=false;if(a>0){a=Math.floor(Math.round(a));c=true}else{a=Math.ceil(a)}var b=Math.abs(a);if((b%2)==0){b++}if(c){return b}else{return -b}},PI:function(){return Math.PI},POWER:function(a,b){return Math.pow(a,b)},SQRT:function(a){return Math.sqrt(a)},RAND:function(){return Math.random()},RND:function(){return Math.random()},ROUND:function(c,b){var a=Math.pow(10,b||0);return Math.round(c*a)/a},ROUNDDOWN:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.floor(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b)},ROUNDUP:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.ceil(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b)},SUM:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){b+=a[i]*1}return b},TRUNC:function(a,b){b=b||0;a=a+"";if(b==0){return a.split(".").shift()}if(a.match(".")){if(b==1){a=a.substr(0,a.length-1)}else{if(b==-1){a=a.split(".").shift();a=a.substr(0,a.length-1)+"0"}}}return a},AVERAGE:function(a){return jFN.SUM(arguments)/jFN.COUNT(arguments)},AVG:function(a){return jFN.AVERAGE(a)},COUNT:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){if(a[i]!=null){b++}}return b},COUNTA:function(){var b=0,a=arrHelpers.flatten(arguments);for(i in a){if(a[i]){b++}}return b},MAX:function(){var b=arrHelpers.toNumbers(arguments),a=b[0];for(i in b){a=(b[i]>a?b[i]:a)}return a},MIN:function(){var a=arrHelpers.toNumbers(arguments),b=a[0];for(i in a){b=(a[i]<b?a[i]:b)}return b},ASC:function(a){return a.charCodeAt(0)},CHAR:function(a){return String.fromCharCode(a)},CLEAN:function(a){var b=new RegExp("[cG\x1BcLcJcMcIcK\x07\x1B\f\n\r\t\v]","g");return a.replace(b,"")},CODE:function(a){return jFN.ASC(a)},CONCATENATE:function(){var c=arrHelpers.flatten(arguments),b="",a=this;jQuery.each(c,function(d){a.html.pop();b+=c[d]});return{value:b,html:b}},DOLLAR:function(b,a,f){a=a||2;f=f||"$";var d=jFN.FIXED(b,a,false).value,c;if(b>=0){c=f+d}else{c="-"+f+d.slice(1)}return{value:b,html:c}},FIXED:function(c,b,a){b=(b===undefined?2:b);var f=Math.pow(10,b);c=Math.round(c*f)/f;var d=Globalize.format(c,"n"+b);return{value:c.toFixed(b),html:(a?d.replace(Globalize.culture().numberFormat[","],""):d)}},LEFT:function(a,b){b=b||1;return a.substring(0,b)},LEN:function(a){if(!a){return 0}return a.length},LOWER:function(a){return a.toLowerCase()},MID:function(b,c,a){if(!b||!c||!a){return this.jS.s.error({error:"ERROR"})}return b.substring(c-1,a+c-1)},REPLACE:function(b,f,c,d){if(!b||!f||!c||!d){return this.jS.s.error({error:"ERROR"})}var a=b.split("");a.splice(f-1,c);a.splice(f-1,0,d);return a.join("")},REPT:function(b,d){var a="";for(var c=0;c<d;c++){a+=b}return a},RIGHT:function(a,b){b=b||1;return a.substring(a.length-b,a.length)},SEARCH:function(c,a,d){d=d||0;if(d){a=a.split("");a.splice(0,d-1);a=a.join("")}var b=a.search(c);if(b<0){return this.jS.s.error({error:"#VALUE!"})}return d+(d?0:1)+b},SUBSTITUTE:function(d,a,c,f){f=f||0;a=new RegExp(a,"g");var b=1;d=d.replace(a,function(h,k,l,j){var g=h;if(f){if(b>=f){g=c}}else{g=c}b++;return g});return d},TEXT:function(){return this.jS.s.error({error:"Not Yet Implemented"})},UPPER:function(a){return a.toUpperCase()},VALUE:function(a){if(jQuery.isNumeric(a)){return a*=1}else{return this.jS.s.error({error:"#VALUE!"})}},NOW:function(){var a=new Date();return{value:a,html:dates.toString(a)}},TODAY:function(){var a=new Date();return{value:dates.toCentury(a)-1,html:dates.toString(a,"d")}},WEEKENDING:function(b){var a=new Date();a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+5-a.getDay()-((b||0)*7));return{value:a,html:dates.toString(a,"d")}},WEEKDAY:function(b,c){b=dates.get(b);var a=b.getDay();c=(c?c:1);switch(c){case 3:switch(a){case 0:return 7;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6}break;case 2:switch(a){case 0:return 6;case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;case 6:return 5}break;case 1:a++;break}return a},WEEKNUM:function(a){a=dates.get(a);return dates.week(a)+1},YEAR:function(a){a=dates.get(a);return a.getFullYear()},DAYSFROM:function(b,c,a){return Math.floor((new Date()-new Date(b,(c-1),a))/dates.dayDiv)},DAYS:function(f,c){var b=dates.get(f),a=dates.get(c),d=1000*60*60*24;return Math.round(Math.abs(b.getTime()-a.getTime())/d)},DAY:function(a){a=dates.get(a);return a.getDate()},DAYS360:function(g,c,j){g=dates.get(g);c=dates.get(c);var a=g.getDate(),f=c.getDate(),d=dates.isLastDayOfMonth(g),h=dates.isLastDayOfMonth(c),b=dates.diffMonths(g,c);if(j){a=Math.min(a,30);f=Math.min(f,30)}else{if(d){a=30}if(h){if(a<30){b++;f=1}else{f=30}}}return(b*30)+(f-a)},DATE:function(c,d,a){var b=new Date(c,d-1,a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},DATEVALUE:function(a){a=dates.get(a);return{html:dates.toString(a,"d"),value:dates.toCentury(a)}},EDATE:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},EOMONTH:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a+1);b=new Date(b.getFullYear(),b.getMonth(),0);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},HOUR:function(a){a=times.fromMath(a);return a.hour},MINUTE:function(a){return times.fromMath(a).minute},MONTH:function(a){a=dates.get(a);return a.getMonth()+1},SECOND:function(a){return times.fromMath(a).second},TIME:function(a,h,c){var b=new Date();c=(c?c:0),h=(h?h:0),a=(a?a:0);if(c&&c>60){var d=(((c/60)+"").split(".")[0])*1;c=c-(d*60);h+=d}if(h&&h>60){var g=(((h/60)+"").split(".")[0])*1;h=h-(g*60);a+=g}var f=(a*60*60*1000)+(h*60*1000)+(c*1000);return f/dates.dayDiv},TIMEVALUE:function(a){if(!isNaN(a)){return a}if(/([0]?[1-9]|1[0-2])[:][0-5][0-9]([:][0-5][0-9])?[ ]?(AM|am|aM|Am|PM|pm|pM|Pm)/.test(a)){return times.fromString(a,true)}else{if(/([0]?[0-9]|1[0-9]|2[0-3])[:][0-5][0-9]([:][0-5][0-9])?/.test(a)){return times.fromString(a)}}return 0},WORKDAY:function(a,j,g){var d={1:true,2:true,3:true,4:true,5:true},a=dates.get(a),j=(j&&!isNaN(j)?j:0),c=0,b=0,h=new Date();h=a;if(g){if(!jQuery.isArray(g)){g=[g]}g=arrHelpers.flatten(g);var f={};jQuery.each(g,function(k){if(g[k]){f[dates.toString(dates.get(g[k]),"d")]=true}});g=f}else{g={}}while(b<j){h=new Date(h.setDate(h.getDate()+1));if(d[h.getDay()]){if(!g[dates.toString(h,"d")]){b++}}c++}return{html:dates.toString(h,"d"),value:dates.toCentury(h)}},YEARFRAC:function(a,f,d){a=dates.get(a);f=dates.get(f);if(!a||!f){return this.jS.s.error({error:"#VALUE!"})}d=(d?d:0);var c=dates.diff(a,f,d),b=dates.calcAnnualBasis(a,f,d);return c/b},AND:function(){var b=arguments,c,a=this;jQuery.each(b,function(d){a.html.pop();if(b[d]!==true&&c==undefined){c=jFN.FALSE()}});if(!c){c=jFN.TRUE()}return c},FALSE:function(){return{value:false,html:"FALSE"}},IF:function(j,g,d){var h,f,b=this.html.pop(),a=this.html.pop(),c=this.html.pop();if(j.condition!=undefined){if(j.condition){h=g;f=a;this.html.pop()}else{h=d;f=b}}else{if(j){h=g;f=a;this.html.pop()}else{h=d;f=b}}return{value:h,html:f}},NOT:function(b){var a=new String(b);this.html.pop();if(!b){a.condition=true;return{value:a,html:"TRUE"}}a.condition=false;return{value:a,html:"FALSE"}},OR:function(){var a=false;for(var b in arguments){this.html.pop();if((arguments[b]==true||arguments[b]==1)&&!a){a=true}}if(a){return{value:true,html:"TRUE"}}return{value:false,html:"FALSE"}},TRUE:function(){return{value:true,html:"TRUE"}},GREATER:function(c,b){var a;this.html.pop();this.html.pop();if(c>b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"}}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"}}},LESS:function(c,b){var a;this.html.pop();this.html.pop();if(c<b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"}}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"}}},EQUAL:function(c,b){var a;this.html.pop();this.html.pop();c=(c.condition!=undefined?c.condition:c);b=(b.condition!=undefined?b.condition:b);if(c==b){return{value:true,html:"TRUE"}}else{return{value:false,html:"FALSE"}}},GREATER_EQUAL:function(c,b){var a;this.html.pop();this.html.pop();if(c>=b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"}}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"}}},LESS_EQUAL:function(c,b){var a;this.html.pop();this.html.pop();if(c<=b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"}}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"}}},IMG:function(a){return{html:jQuery(document.createElement("img")).attr("src",a)}},GETHTML:function(){return this.html[0]},TRIM:function(a){if(typeof(a)=="string"){a=jQuery.trim(a)}return a},HYPERLINK:function(b,a){a=(a?a:"LINK");return{html:jQuery(document.createElement("a")).attr("href",b).attr("target","_new").text(a)}},DROPDOWN:function(){var a=this,f=this.jS,b=arrHelpers.flatten(arguments),d=this.td.children().detach(),h=f.getTdLocation(a.td),g=jQuery(a.td);b=arrHelpers.unique(b);if(!d.length||a.needsUpdated){var j="dropdown"+this.sheet+"_"+h.row+"_"+h.col+"_"+f.I;d=jQuery('<select name="'+j+'" id="'+j+'" class="jSDropdown" />').mouseup(function(){f.cellEdit(g)}).change(function(){a.value=d.val();f.calcDependencies.apply(a,[a.calcDependenciesLast])});d[0].cell=a;f.controls.inputs[f.i]=f.obj.inputs().add(d);for(var c=0;c<(b.length<=50?b.length:50);c++){if(b[c]){d.append('<option value="'+b[c]+'">'+b[c]+"</option>")}}if(!f.s.editable){d.attr("disabled",true)}else{f.s.parent.bind("sheetKill",function(){a.value=d.val();g.text(a.value)})}d.val(a.value).change()}return{value:a.value,html:d}},RADIO:function(){var l=this,f=this.jS,k=arrHelpers.flatten(arguments),d=this.td.children().detach(),h=f.getTdLocation(l.td),b=jQuery(l.td),g=jQuery([]);k=arrHelpers.unique(k);if(!d.length||l.needsUpdated){var a="radio"+this.sheet+"_"+h.row+"_"+h.col+"_"+f.I;d=jQuery('<span class="jSRadio"/>').mousedown(function(){f.cellEdit(b)});d[0].jSCell=l;f.controls.inputs[f.i]=f.obj.inputs().add(d);for(var c=0;c<(k.length<=25?k.length:25);c++){if(k[c]){var j=jQuery('<input type="radio" name="'+a+'" class="'+a+'" />').val(k[c]).change(function(){l.value=jQuery(this).val();f.calcDependencies.apply(l,[l.calcDependenciesLast])});g=g.add(j);if(k[c]==l.value){j.attr("checked","true");j.change()}d.append(j).append(jQuery("<span>"+k[c]+"</span>").click(function(){$(this).prev().click()})).append("<br />")}}if(!f.s.editable){l.value=d.find("input:checked").val();d.find("input").attr("disabled",true)}else{f.s.parent.bind("sheetKill",function(){l.value=g.filter(":checked").val();b.text(l.value)})}}return{value:l.value,html:d}},CHECKBOX:function(b){if(jQuery.isArray(b)){b=b[0]}var a=this,f=this.jS,c=this.td.children().detach(),h=f.getTdLocation(a.td),d=$([]),g=jQuery(a.td);if((!c.length||a.needsUpdated)){var j="checkbox"+this.sheet+"_"+h.row+"_"+h.col+"_"+f.I;d=jQuery('<input type="checkbox" name="'+j+'" class="'+j+'" />').val(b).change(function(){if(d.is(":checked")){a.value=b}else{a.value=""}f.calcDependencies.apply(a,[a.calcDependenciesLast])});if(!f.s.editable){d.attr("disabled",true)}else{f.s.parent.bind("sheetKill",function(){a.value=(a.value=="true"||d.is(":checked")?b:"");g.text(a.value)})}c=jQuery('<span class="jSCheckbox"/>').append(d).append("<span>"+b+"</span><br />").mousedown(function(){f.cellEdit(g)});c[0].cell=a;f.controls.inputs[f.i]=f.obj.inputs().add(c);if(b==a.value){d.attr("checked",true);d.change()}}return{value:a.value=="true"||d.is(":checked")?b:"",html:c}},BARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"bar",data:a,legend:b,title:c}])}},HBARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"hbar",data:a,legend:b,title:c}])}},LINECHART:function(b,a){return{value:"",html:jSE.chart.apply(this,[{type:"line",x:{data:b},y:{data:a},title:""}])}},PIECHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"pie",data:a,legend:b,title:c}])}},DOTCHART:function(g,d,a,c,b,f){return{value:"",html:jSE.chart.apply(this,[{type:"dot",data:(a?a:g),x:{data:g,legend:c},y:{data:(d?d:g),legend:(b?b:c)},title:f}])}},CELLREF:function(a){return(this.jS.spreadsheets[a]?this.jS.spreadsheets[a]:"Cell Reference Not Found")},CALCTIME:function(){var a=this;this.s.parent.one("sheetCalculation",function(){a.jS.getTd(a.sheet,a.row,a.col).text(a.jS.time.diff())});return""},HLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,d-1,c[b].col)}}return a},VLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,c[b].row,d)}}return a},THISROWCELL:function(a){var b=this.jS,c=b.getTdLocation(this.td);if(isNaN(a)){a=jSE.columnLabelIndex(a)}return b.updateCellValue(this.sheet,c.row,a)},THISCOLCELL:function(c){var a=this.jS,b=a.getTdLocation(this.td);return a.updateCellValue(this.sheet,c,b.col)}};var key={BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,ALT:18,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,C:67,F:70,V:86,X:88,Y:89,Z:90};var arrHelpers={math:Math,toNumbers:function(a){a=this.flatten(a);for(i in a){if(a[i]){a[i]=jQuery.trim(a[i]);if(isNaN(a[i])){a[i]=0}else{a[i]=a[i]*1}}else{a[i]=0}}return a},unique:function(b){var d=[],c=b.length;for(var g=0;g<c;g++){for(var f=g+1;f<c;f++){if(b[g]===b[f]){f=++g}}d.push(b[g])}return d},flatten:function(a){var f=[];for(var c=0,b=a.length;c<b;c++){var d=Object.prototype.toString.call(a[c]).split(" ").pop().split("]").shift().toLowerCase();if(d){f=f.concat(/^(array|collection|arguments|object)$/.test(d)?this.flatten(a[c]):a[c])}}return f},insertAt:function(a,c,b){jQuery(c).each(function(){if(b>-1&&b<=a.length){a.splice(b,0,this)}});return a},closest:function(h,a,c){h=h||[];a=a||0;c=c||0;var f=h[c],g=this.math.abs(a-f);var b=h.length-1;if(b){do{var d=this.math.abs(a-h[b]);if(d<g){g=d;f=h[b]}}while(b--)}return f}};var dates={math:Math,dayDiv:86400000,toCentury:function(a){return this.math.round(this.math.abs((new Date(1900,0,-1))-a)/this.dayDiv)},get:function(b){if(b.getMonth){return b}else{if(isNaN(b)){return new Date(Globalize.parseDate(b))}else{b*=this.dayDiv;var a=(new Date(1900,0,-1))*1;b+=a;b=new Date(b);return b}}},week:function(a){var b=new Date(a.getFullYear(),0,1);return this.math.ceil((((a-b)/this.dayDiv)+b.getDay()+1)/7)},toString:function(a,b){if(!b){return Globalize.format(a)}return Globalize.format(a,Globalize.culture().calendar.patterns[b])},diff:function(d,b,c){switch(c){case 0:return this.days360Nasd(d,b,0,true);case 1:case 2:case 3:var a=this.math.abs(b-d)/this.dayDiv;return a;case 4:return this.days360Euro(d,b)}},diffMonths:function(c,b){var a;a=(b.getFullYear()-c.getFullYear())*12;a-=c.getMonth()+1;a+=b.getMonth()+1;return a},days360:function(c,g,d,b,a,f){return((g-c)*360)+((b-d)*30)+(f-a)},days360Nasd:function(b,f,a,c){var d=b.getDate(),k=b.getMonth(),j=b.getFullYear(),h=f.getDate(),g=f.getMonth(),l=f.getFullYear();if((g==2&&this.isEndOfMonth(h,g,l))&&((k==2&&this.isEndOfMonth(d,k,j))||a==3)){h=30}if(h==31&&(d>=30||a==3)){h=30}if(d==31){d=30}if(c&&k==2&&this.isEndOfMonth(d,k,j)){d=30}return this.days360(j,l,k,g,d,h)},days360Euro:function(j,c){var a=j.getDate(),f=j.getMonth(),d=j.getFullYear(),g=c.getDate(),b=c.getMonth(),h=c.getFullYear();if(a==31){a=30}if(g==31){g=30}return this.days360(d,h,f,b,a,g)},isEndOfMonth:function(a,c,b){return a==(new Date(b,c+1,0,23,59,59)).getDate()},isLeapYear:function(a){return new Date(a,1,29).getMonth()==1},calcAnnualBasis:function(a,c,h){switch(h){case 0:case 2:case 4:return 360;case 3:return 365;case 1:var b=a.getDate(),k=a.getMonth(),g=a.getFullYear(),d=c.getDate(),f=c.getMonth(),l=c.getFullYear(),m;if(g==l){if(this.isLeapYear(g)){m=366}else{m=365}}else{if(((l-1)==g)&&((k>f)||((k==f)&&b>=d))){if(this.isLeapYear(g)){if(k<2||(k==2&&b<=29)){m=366}else{m=365}}else{if(this.isLeapYear(l)){if(f>2||(f==2&&d==29)){m=366}else{m=365}}else{m=365}}}else{for(var j=g;j<=l;j++){if(this.isLeapYear(j)){m+=366}else{m+=365}}m=m/(l-g+1)}}return m}},lastDayOfMonth:function(a){a.setDate(0);return a.getDate()},isLastDayOfMonth:function(a){return(a.getDate()==this.lastDayOfMonth(a))}};var times={math:Math,fromMath:function(c){var a={},b=this;a.hour=((c*24)+"").split(".")[0]*1;a.minute=function(d){d=b.math.round(d*24*100)/100;d=(d+"").split(".");var f=0;if(d[1]){if(d[1].length<2){d[1]+="0"}f=d[1]*0.6}return b.math.round(f)}(c);a.second=function(h){h=b.math.round(h*24*10000)/10000;h=(h+"").split(".");var f=0;if(h[1]){for(var g=0;g<4;g++){if(!h[1].charAt(g)){h[1]+="0"}}var d=((h[1]*0.006)+"").split(".");if(d[1]){if(d[1]&&d[1].length>2){d[1]=d[1].substr(0,2)}return b.math.round(d[1]*0.6)}}return f}(c);return a},fromString:function(c,j){var d=new Date(),h=c,a,g,f,b,k;if(j){k=h.substr(-2).toLowerCase();h=h.replace(/(am|pm)/i,"")}h=h.split(":");g=h[0]*1;f=h[1]*1;b=(h[2]?h[2]:0)*1;if(j&&k=="pm"){g+=12}return jFN.TIME(g,f,b)}};var math={log10:function(a){return Math.log(a)/2.302585092994046},signum:function(a){return(a/Math.abs(a))||a},log1p:function(a){var b=0,d=50;if(a<=-1){return"-INF"}if(a<0||a>1){return Math.log(1+a)}for(var c=1;c<d;c++){if((c%2)===0){b-=Math.pow(a,c)/c}else{b+=Math.pow(a,c)/c}}return b}};jQuery.print=function(b){var a=window.open();a.document.write("<html><body><xmp>"+b+"\n</xmp></body></html>");a.document.close()};